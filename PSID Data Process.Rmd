---
title: "PSID Data Process"
output: 
  github_document:
    toc: true
    toc_depth: 3
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)
```

## Data Process Summary

1.  First, we create a unique ID for each person to avoid confusion.

2.  Next, we filter personal information:

-   Define variables for personal information, including birth date,
    individual status in the survey, and family identity.

-   Calculate the person’s birth date.

-   Remove individuals whose identity does not match the criteria.

3.  Third, we define fertility information, including:

-   The birth date of the first child, the most recent year of fertility
    information update, and the number of children.

-   Calculate the children’s ages.

-   Remove individuals with no fertility information.

-   Remove outliers, such as individuals who had children outside the
    age range of 20-45.

4.  Finally, we define family income, including:

-   After determining the individual’s family identity, extract the time
    series of family income since the individual’s birth.

-   Remove individuals with no family income information.

## Data Resources

We build the data by the PSID Cross_Year Index

[PSID Cross-Year Index
(umich.edu)](https://simba.isr.umich.edu/DC/i.aspx) Link to the website

Those variables can be chosen by years and check which variables are
available in which wave. Furthermore, when I choose the individual
variables and also can link individual to his or her family information.


Our data has two levels include **individuals data index** and **family
public data index**

Clicking the plus sign on the left will display the available variables
and their collection status for each year.

I started with individual-level data to collect information on
individuals and their fertility, then clicked on family-level data to
collect household income data for the corresponding individuals.

For the original data, I chose the variables below:

### Summary Variables

1.  Family interview number ( include 68 family number)

2.  person number

3.  Sequence number

4.  Relationship to head/reference

5.  Whether Individual Is Sample

### **Individuals data index**

1.  Children:
    1.  Birth Dates:
        -   first/only：
            -   month
            -   year
        -   pregnancy：
            -   Total Number Births
            -   Year Birth History Collected
2.  Demographic
    -   Age:
        -   month born
        -   year born
    -   Sex
3.  Family Composition
    -   Always Present in Response FU (family unit)

### **Family public data index**

-   Income
    -   Family income
        -   Taxable: **total family income**

### Packages preparation and upload Data from original dataset

```{r eval=FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(openxlsx)
library(pracma)
library(lubridate)
J336638 <- read_excel("~/Dropbox/Functional Fertility/PSID/J336638.xlsx")
fd<- data.frame(J336638)

```

**Number of Individuals is 84121**

### Define Variables

1.  **Individual date variables**

```{r eval=FALSE}

## release number
release_numbers <- c(
  "ER30000", "V1", "V441", "V1101", "V1801", "V2401", "V3001", 
  "V3401", "V3801",
  "V4301", "V5201", "V5701", "V6301", "V6901", 
  "V7501", "V8201", "V8801", "V10001",
  "V11101", "V12501", "V13701", "V14801", "V16301",
  "V17701", "V19001", "V20301",
  "V21601", "ER2001","ER5001","ER7001", "ER10001", 
  "ER13001", "ER17001", "ER21001", "ER25001", "ER36001", 
  "ER42001", "ER47301",
  "ER53001", "ER60001", "ER66001", "ER72001", "ER78001"
)



## individual birth year
birth_year_vars <- c("ER30404", "ER30434", "ER30468", "ER30503", "ER30540", "ER30575",
                     "ER30611", "ER30647", "ER30694", "ER30738", "ER30811", "ER33106",
                     "ER33206", "ER33306", "ER33406", "ER33506", "ER33606", "ER33706",
                     "ER33806", "ER33906", "ER34006", "ER34106", "ER34206", "ER34307",
                     "ER34506", "ER34706", "ER34906")


birth_month_vars <- c("ER30403", "ER30433", "ER30467", "ER30502", "ER30539", "ER30574",
                      "ER30610", "ER30646", "ER30693", "ER30737", "ER30810", "ER33105",
                      "ER33205", "ER33305", "ER33405", "ER33505", "ER33605", "ER33705",
                      "ER33805", "ER33905", "ER34005", "ER34105", "ER34205", "ER34306",
                      "ER34505", "ER34705", "ER34905")

var_pairs <- list(
  c('ER30404', 'ER30403'),
  c('ER30434', 'ER30433'),
  c('ER30468', 'ER30467'),
  c('ER30503', 'ER30502'),
  c('ER30540', 'ER30539'),
  c('ER30575', 'ER30574'),
  c('ER30611', 'ER30610'),
  c('ER30647', 'ER30646'),
  c('ER30694', 'ER30693'),
  c('ER30738', 'ER30737'),
  c('ER30811', 'ER30810'),
  c('ER33106', 'ER33105'),
  c('ER33206', 'ER33205'),
  c('ER33306', 'ER33305'),
  c('ER33406', 'ER33405'),
  c('ER33506', 'ER33505'),
  c('ER33606', 'ER33605'),
  c('ER33706', 'ER33705'),
  c('ER33806', 'ER33805'),
  c('ER33906', 'ER33905'),
  c('ER34006', 'ER34005'),
  c('ER34106', 'ER34105'),
  c('ER34206', 'ER34205'),
  c('ER34307', 'ER34306'),
  c('ER34506', 'ER34505'),
  c('ER34706', 'ER34705'),
  c('ER34906', 'ER34905')
)

simplified_years <- c("83", "84", "85", "86", "87", "88",
                      "89", "90", "91", "92", "93", "94", 
                      "95", "96", "97", "99", "01", "03", 
                      "05", "07", "09", "11", "13", "15", 
                      "17", "19","21")
```

2.  **Individual status variables**

```{r eval=FALSE}
# Define the list of interview number variables
interview_vars <- c("ER30020", "ER30043", "ER30067", "ER30091", "ER30117", 
                    "ER30138", "ER30160", "ER30188", "ER30217", "ER30246",
                    "ER30283", "ER30313", "ER30343", "ER30373", "ER30399", "ER30429", "ER30463", 
                    "ER30498", "ER30535", "ER30570", "ER30606", "ER30642", "ER30689", 
                    "ER30733", "ER30806", "ER33101", "ER33201", "ER33301", "ER33401", 
                    "ER33501", "ER33601", "ER33701", "ER33801", "ER33901", "ER34001", 
                    "ER34101", "ER34201", "ER34301", "ER34501", "ER34701", "ER34901")

## Sequence number need to be 1-20
sequence_vars <- c(
  "ER30021", "ER30044", "ER30068", "ER30092", 
  "ER30118", "ER30139", "ER30161", "ER30189", 
  "ER30218", "ER30247", "ER30284", "ER30314", 
  "ER30344", "ER30374", "ER30400", "ER30430", 
  "ER30464", "ER30499", "ER30536", "ER30571", 
  "ER30607", "ER30643", "ER30690", "ER30734", 
  "ER30807", "ER33102", "ER33202", "ER33302", 
  "ER33402", "ER33502", "ER33602", "ER33702", 
  "ER33802", "ER33902", "ER34002", "ER34102", 
  "ER34202", "ER34302", "ER34502", "ER34702", 
  "ER34902")

## Select 3,0 as children in the family 
relation_vars_82 <- c(
  "ER30003", "ER30022", "ER30045", "ER30069", "ER30093", "ER30119", 
  "ER30140", "ER30162", "ER30190", "ER30219", "ER30248", "ER30285",
  "ER30315", "ER30345", "ER30375")
  
## Select 0, 30-38 as children in the family  
relation_vars_83 <- c(  
  "ER30401", "ER30431", "ER30465", "ER30500", "ER30537", "ER30572", 
  "ER30608", "ER30644", "ER30691", "ER30735", "ER30808", "ER33103", 
  "ER33203", "ER33303", "ER33403", "ER33503", "ER33603", "ER33703", 
  "ER33803", "ER33903", "ER34003", "ER34103", "ER34203", "ER34303", 
  "ER34503", "ER34703", "ER34903")


r_xx<- 
c(
  "R_83", "R_84", "R_85", "R_86", "R_87", "R_88", "R_89", "R_90", "R_91", "R_92",
  "R_93", "R_94", "R_95", "R_96", "R_97", "R_99", "R_01", "R_03", "R_05", "R_07",
  "R_09", "R_11", "R_13", "R_15", "R_17", "R_19", "R_21"
)


## Here relationship need to be adjusted by different value after 1982
```

3.  **Family Income Variables**

```{r eval=FALSE}
family_income_vars <- c(
 "V81", "V529", "V1514", "V2226", "V2852", "V3256", 
 "V3676", "V4154", "V5029", "V5626","V6173", "V6766", 
 "V7412", "V8065", "V8689", "V9375", "V11022", "V12371", 
 "V13623", "V14670",
  "V16144", "V17533", "V18875", "V20175", "V21481", 
 "V23322", "ER4153", "ER6993", "ER9244",
  "ER12079", "ER16462", "ER20456", "ER24099", 
 "ER28037", "ER41027", "ER46935", "ER52343",
  "ER58152", "ER65349", "ER71426", "ER77448", "ER81775")


parental_income_vars <- c(
  "V76", "V518", "V1205", "V1906", "V2507", "V3060", "V3472", "V3872", 
  "V4386", "V5297", "V5796", "V6408", "V6998", "V7590", "V8283", "V8891", 
  "V10277", "V11419", "V12818", "V13920", "V14935", "V16435", "V17851", 
  "V19151", "V20451", "V21959", "ER4146", "ER6986", "ER9237", "ER12069", 
  "ER16452", "ER20449", "ER24100", "ER27953", "ER40943", "ER46851", 
  "ER52259", "ER58060", "ER65253", "ER71330", "ER77352", "ER81679"
)

Other_income_var <- c(
  "V79", "V521", "V1222", "V1924", "V2525", "V3078", "V3490", "V3891", 
  "V4406", "V5318", "V5817", "V6428", "V7033", "V7625", "V8318", "V8926", 
  "V10382", "V11561", "V12968", "V14070", "V15085", "V16585", "V18001", 
  "V19301", "V20601", "V22373", "ER4150", "ER6990", "ER9241", "ER12073", 
  "ER16456", "ER20453", "ER24102", "ER28009", "ER40999", "ER46907", 
  "ER52315", "ER58124", "ER65321", "ER71398", "ER77420", "ER81747"
)


years <- c(
  "1968", "1969", "1970", "1971", "1972", "1973", "1974", 
  "1975", "1976", "1977",
  "1978" ,"1979", "1980" ,"1981", "1982", "1983" ,"1984", 
  "1985" ,"1986" ,"1987",
   "1988", "1989", "1990", "1991", "1992", "1993", "1994", 
  "1995", "1996", "1997",
   "1999", "2001", "2003", "2005", "2007", "2009", "2011", 
  "2013", "2015", "2017",
  "2019","2021"
)

new_years <- c("1998", "2000", "2002", "2004", 
               "2006", "2008", "2010", "2012", "2014", 
               "2016", "2018", "2020")



all_years <- c("1968", "1969", "1970", "1971", "1972", 
               "1973", "1974", "1975", "1976", "1977",
               "1978", "1979", "1980", "1981", 
               "1982", "1983", "1984", "1985", "1986", 
               "1987", "1988", "1989", "1990", "1991", 
               "1992", "1993", "1994", "1995", "1996", 
               "1997", "1998", "1999", "2000", "2001", 
               "2002", "2003", "2004", "2005", "2006", 
               "2007", "2008", "2009", "2010", "2011", 
               "2012", "2013", "2014", "2015", "2016", 
               "2017", "2018", "2019", "2020","2021")


# Function to format years by adding '2' in front
format_years_with_2 <- function(year_vector) {
  return(paste0("2", year_vector))  # Add '2' in front of the year
}

# Creating the new formatted year variables
year <- format_years_with_2(years)
new_year <- format_years_with_2(new_years)
all_year <- format_years_with_2(all_years)



age_var <- c(
  "age_68", "age_69", "age_70", "age_71", "age_72", "age_73", "age_74", "age_75", 
  "age_76", "age_77", "age_78", "age_79", "age_80", "age_81", "age_82", "age_83", 
  "age_84", "age_85", "age_86", "age_87", "age_88", "age_89", "age_90", "age_91", 
  "age_92", "age_93", "age_94", "age_95", "age_96", "age_97", "age_99", "age_01", 
  "age_03", "age_05", "age_07", "age_09", "age_11", "age_13", "age_15", "age_17", 
  "age_19", "age_21"
)


```

## CPI-U Standardized

### Preparation of CPI data

The data resource is from FRED [Consumer Price Index for All Urban
Consumers: All Items in U.S. City
Average](https://fred.stlouisfed.org/series/CPIAUCSL)

```{r}
cpi_data <- read.csv("/Users/huy/Rstudio/PSID/CPIAUCSL.csv")
cpi_data$DATE <- as.Date(cpi_data$DATE, format="%Y-%m-%d")
cpi_data$Year <- year(cpi_data$DATE)
```

### Calculation of annual cpi-u value

```{r}
annual_cpi <- cpi_data %>%
  group_by(Year) %>%
  summarise(CPIU = mean(CPIAUCSL, na.rm = TRUE))


cpi <- annual_cpi %>%
  filter(Year >= 1968 & Year <= 2020) 
```

### Calculation of CPI index

#### 1968 as the base year

```{r}
cpi$CPIU68 <- cpi$CPIU[1]/ cpi$CPIU 
```

#### 2020 as the base year

```{r}
cpi$CPIU20 <- cpi$CPIU[53]/ cpi$CPIU 
```

### For each wave to prepare cpi index

```{r}
c68<- cpi$CPIU20[1:18]
c69<- cpi$CPIU20[2:19]
c70 <- cpi$CPIU20[3:20]
c71 <- cpi$CPIU20[4:21]
c72 <- cpi$CPIU20[5:22]
c73 <- cpi$CPIU20[6:23]
c74 <- cpi$CPIU20[7:24]
c75 <- cpi$CPIU20[8:25]
c76 <- cpi$CPIU20[9:26]
c77 <- cpi$CPIU20[10:27]
c78 <- cpi$CPIU20[11:28]
c79 <- cpi$CPIU20[12:29]
c80 <- cpi$CPIU20[13:30]
c81 <- cpi$CPIU20[14:31]
c82 <- cpi$CPIU20[15:32]
c83 <- cpi$CPIU20[16:33]
c84 <- cpi$CPIU20[17:34]
c85 <- cpi$CPIU20[18:35]
c86 <- cpi$CPIU20[19:36]
c87 <- cpi$CPIU20[20:37]
c88 <- cpi$CPIU20[21:38]
c89 <- cpi$CPIU20[22:39]
c90 <- cpi$CPIU20[23:40]
c91 <- cpi$CPIU20[24:41]
c92 <- cpi$CPIU20[25:42]
c93 <- cpi$CPIU20[26:43]
c94 <- cpi$CPIU20[27:44]
c95 <- cpi$CPIU20[28:45]
c96 <- cpi$CPIU20[29:46]
c97 <- cpi$CPIU20[30:47]
c98 <- cpi$CPIU20[31:48]
c99 <- cpi$CPIU20[32:49]
c00 <- cpi$CPIU20[33:50]
```

# Data Organization

### Complete individuals information

1.  **Create Unique ID number**

```{r eval=FALSE}
fd <- fd %>%
  mutate(ID = (ER30001 * 1000) + ER30002) # add unique ID

fd <- fd %>%
  rename(sex = ER32000,
  year_birth_info_most_recently_updated = ER32021, 
  No_birth_in_recently_updated_year = ER32022)
```

2.  **Select individual birth information**

```{r eval=FALSE}
create_formatted_date <- function(fd, year_col, month_col, simplified_year) {
  fd %>%
    mutate(
      formatted_date = case_when(
        .[[year_col]] %in% c(9999, 0) ~ 9999,  
        # if year is 9999 or 0，equal to 9999
        .[[month_col]] %in% c(0, 99) ~ 99,  
        # if month is 9999 or 0，equal to 99
        TRUE ~ .[[year_col]] + (.[[month_col]] - 1) / 12  
      )
    ) %>%
    rename(!!simplified_year := formatted_date)
}


for (i in seq_along(var_pairs)) {
  pair <- var_pairs[[i]]
  year_col <- pair[1]
  month_col <- pair[2]
  
  # create the new variable to merge birth information
  fd <- create_formatted_date(fd, year_col, month_col, simplified_years[i])
}


fd[simplified_years] <- lapply(fd[simplified_years], as.numeric)

fd <- fd %>%
  pivot_longer(cols = all_of(simplified_years), 
               names_to = "variable", values_to = "birth_year") %>%
  filter(birth_year >= 1968 & birth_year < 2001) %>%
  distinct()

fd <- fd %>%
  group_by(ID) %>%  # using ID number to remove duplicate data
  slice(1) %>%
  ungroup()




# age at end of 2021
fd <- fd %>%
  mutate(age_end_2021 = 2022 - birth_year)

```

**After first age selection, the number of individuals is 33172, 39.4%
of all sample**

### Children Birth Information

1.  **First child born year**

```{r eval=FALSE}
fd <- fd %>%
  mutate(
    first_child_born = case_when(
      ER32024 == 9999 ~ 9999,  # if year is 9999，equal to 9999
      ER32023 == 21 ~ ER32024,  # Season transformation
      ER32023 == 22 ~ ER32024 + 0.25,  
      ER32023 == 23 ~ ER32024 + 0.5, 
      ER32023 == 24 ~ ER32024 + 0.75,  
      ER32023 == 98 ~ ER32024 + 0.5,  
      ER32023 == 99 ~ 99,  # if month is 9999，equal to 99
      TRUE ~ ER32024 + (ER32023 - 1) / 12  
    )
  )
```

2.  **Does individual has children before 2021?**

```{r eval=FALSE}
fd <- fd %>%
  mutate(
    had_children_before_2021 = case_when(
      No_birth_in_recently_updated_year == 0 ~ "N",  # No child
      No_birth_in_recently_updated_year %in% c(98, 99) & 
      first_child_born == 9999 ~ "F",  
      # lost child birth and no. information
      (!is.na(first_child_born) & first_child_born < 2022) | No_birth_in_recently_updated_year != 0 ~ "Y",  
      # before 2022 has child born or ER32022 not zero
      TRUE ~ "N"  # other cases
    )
  )

```

3.  **Calculate the age at first born**

-   Keep individuals age between 15-45(survey ignore birth information
    after individual age 45) and 0(no child),
-   and filter child born after 1988 (individual who born in the first
    wave at age 20 in 1988)

```{r eval=FALSE}
fd <- fd %>%
  filter(first_child_born >= 1983 | first_child_born == 9999) %>%  
  mutate(
    age_at_first_birth = ifelse(first_child_born == 9999, 0, 
                                first_child_born - birth_year)  
  ) %>%
  filter(age_at_first_birth == 0 | (age_at_first_birth >= 15 &
                                      age_at_first_birth <= 45))  
```

**After second child birth selection, the number of individuals is
29740, 35.4% of all sample**

### Family incomes Information

```{r eval=FALSE}
income_year <- setNames(year, family_income_vars)

# rename the income variable as "years"

fd <- fd %>%
  rename_with(~ setNames(year, family_income_vars), 
              all_of(family_income_vars))

#create time series

for (year in new_year) {
  fd[[year]] <- NA
}

```

### For version 3

```{r}
income_year <- setNames(years, parental_income_vars)

# rename the income variable as "years"

fd <- fd %>%
  rename_with(~ setNames(years, parental_income_vars), 
              all_of(parental_income_vars))

#create time series

for (year in new_years) {
  fd[[year]] <- NA
}
```

## Adjusted data frame

1.  **Filter relationship before 1982, only keep value = 3,0, make sure
    individuals in current family as child**

```{r eval=FALSE}
# First filter the Relation to the head variables before 1982
fd<- fd %>%
  filter(if_all(all_of(relation_vars_82), ~ . %in% c(0, 3)))


new_Re_83 <- c(
    "ER30401" = "R_83",
    "ER30431" = "R_84",
    "ER30465" = "R_85",
    "ER30500" = "R_86",
    "ER30537" = "R_87",
    "ER30572" = "R_88",
    "ER30608" = "R_89",
    "ER30644" = "R_90",
    "ER30691" = "R_91",
    "ER30735" = "R_92",
    "ER30808" = "R_93",
    "ER33103" = "R_94",
    "ER33203" = "R_95",
    "ER33303" = "R_96",
    "ER33403" = "R_97",
    "ER33503" = "R_99",
    "ER33603" = "R_01",
    "ER33703" = "R_03",
    "ER33803" = "R_05",
    "ER33903" = "R_07",
    "ER34003" = "R_09",
    "ER34103" = "R_11",
    "ER34203" = "R_13",
    "ER34303" = "R_15",
    "ER34503" = "R_17",
    "ER34703" = "R_19",
    "ER34903" = "R_21"
)


col_names <- names(fd)


for (i in seq_along(col_names)) {
    if (col_names[i] %in% names(new_Re_83)) {
        col_names[i] <- new_Re_83[col_names[i]]
    }
}

names(fd) <- col_names



# Adjust age variables

new_age_var <- c(
    "ER30004" = "age_68",
    "ER30023" = "age_69",
    "ER30046" = "age_70",
    "ER30070" = "age_71",
    "ER30094" = "age_72",
    "ER30120" = "age_73",
    "ER30141" = "age_74",
    "ER30163" = "age_75",
    "ER30191" = "age_76",
    "ER30220" = "age_77",
    "ER30249" = "age_78",
    "ER30286" = "age_79",
    "ER30316" = "age_80",
    "ER30346" = "age_81",
    "ER30376" = "age_82",
    "ER30402" = "age_83",
    "ER30432" = "age_84",
    "ER30466" = "age_85",
    "ER30501" = "age_86",
    "ER30538" = "age_87",
    "ER30573" = "age_88",
    "ER30609" = "age_89",
    "ER30645" = "age_90",
    "ER30692" = "age_91",
    "ER30736" = "age_92",
    "ER30809" = "age_93",
    "ER33104" = "age_94",
    "ER33204" = "age_95",
    "ER33304" = "age_96",
    "ER33404" = "age_97",
    "ER33504" = "age_99",
    "ER33604" = "age_01",
    "ER33704" = "age_03",
    "ER33804" = "age_05",
    "ER33904" = "age_07",
    "ER34004" = "age_09",
    "ER34104" = "age_11",
    "ER34204" = "age_13",
    "ER34305" = "age_15",
    "ER34504" = "age_17",
    "ER34704" = "age_19",
    "ER34904" = "age_21"
)

col_names <- names(fd)


for (i in seq_along(col_names)) {
    if (col_names[i] %in% names(new_age_var)) {
        col_names[i] <- new_age_var[col_names[i]]
    }
}

names(fd) <- col_names



## Rename sample and respondent variables

fd<- fd %>%
  rename(Wtr_sample = ER32006)
        # , Wtr_responding= ER32001)


## Rename the birth order of individual

fd <- fd %>%
  rename(
    Birth_Order_to_Father = ER32020,  # ORDER OF BIRTH TO FATHER
    Total_Children_Born_to_Father = ER32019,  # TOTAL # CHILDREN BORN TO FATHER
    Birth_Order_to_Mother = ER32013,  # ORDER OF BIRTH TO MOTHER
    Marital_Status_of_Mother_at_Birth = ER32015,  # MARITAL STATUS OF MOTHER AT BIRTH
    Total_Children_Born_to_Mother = ER32012  # TOTAL # CHILDREN BORN TO MOTHER
  )



## Completely lost birth information
fd<- fd %>%
filter(had_children_before_2021 != "F") 

```

2.  **Reconstruct the dataframe and reorder the variables**

```{r eval=FALSE}
# Filter age_at_first_birth, No_birth_in_recently_updated_year,
# first_child_born, year_birth_info_most_recently_updated 
# which is not useful data point
fd <- fd %>%
  filter(
    !(age_at_first_birth == 0 &
      No_birth_in_recently_updated_year %in% c(0,99) &
      first_child_born == 9999 &
      year_birth_info_most_recently_updated == 9999)
  )

# Remove unnecessary variables

fd <- select(fd,-ER30001, -ER30002,-ER32023,-ER32024,
             -one_of(birth_month_vars),
             -one_of(birth_year_vars),-one_of(release_numbers),
             -one_of(relation_vars_82), 
             -variable,- one_of(interview_vars))

## For version3, remove the Family income and other income var

fd <- select(fd, -one_of(age_var),-one_of(Other_income_var))


# Reorder the data structure
fda_data <- fd %>%  select(ID, sex, birth_year, age_end_2021, 
                           age_at_first_birth,
                           No_birth_in_recently_updated_year,
                           first_child_born,
                           year_birth_info_most_recently_updated,had_children_before_2021,
                           all_of(all_years), all_of(all_year),all_of(r_xx),
                           all_of(sequence_vars),Wtr_sample)



## For version 3

fda_data <- fd %>%
  select(ID, sex, birth_year, age_end_2021, 
         Birth_Order_to_Father, 
         Total_Children_Born_to_Father, 
         Birth_Order_to_Mother, 
         Marital_Status_of_Mother_at_Birth, 
         Total_Children_Born_to_Mother,
         age_at_first_birth,
         No_birth_in_recently_updated_year,
         first_child_born,
         year_birth_info_most_recently_updated, 
         had_children_before_2021,
         all_of(all_years), 
         all_of(r_xx),
         all_of(sequence_vars), 
         everything())

```

**After third data selection, the number of individuals is 22451, 26.7%
of all sample**

## Group and filter individuals based on their birth year, from 1968 to 2000.

Transfer birth year as int.

```{r eval=FALSE}
fda_data <- fda_data %>%
  mutate(birth_year_int = floor(birth_year))

fda_data['birth_year_int'] <- lapply(fda_data['birth_year_int'], as.numeric)


# For version 1
inc_var <- c("fa_inc_0", "fa_inc_1", "fa_inc_2", "fa_inc_3", 
             "fa_inc_4", 
               "fa_inc_5", "fa_inc_6", "fa_inc_7", "fa_inc_8", 
             "fa_inc_9", 
               "fa_inc_10", "fa_inc_11", "fa_inc_12", "fa_inc_13", 
             "fa_inc_14", 
               "fa_inc_15", "fa_inc_16", "fa_inc_17", "fa_inc_18", 
             "fa_inc_19", 
               "fa_inc_20")



# For version 2
inc_var1 <- c("fa_inc_0", "fa_inc_1", "fa_inc_2", "fa_inc_3", 
             "fa_inc_4", 
               "fa_inc_5", "fa_inc_6", "fa_inc_7", "fa_inc_8", 
             "fa_inc_9", 
               "fa_inc_10", "fa_inc_11", "fa_inc_12", "fa_inc_13", 
             "fa_inc_14", 
               "fa_inc_15", "fa_inc_16", "fa_inc_17")

# For Version 3

par_inc <- c("pa_inc_0", "pa_inc_1", "pa_inc_2", "pa_inc_3", 
             "pa_inc_4", "pa_inc_5", "pa_inc_6", "pa_inc_7", 
             "pa_inc_8", "pa_inc_9", "pa_inc_10", "pa_inc_11", 
             "pa_inc_12", "pa_inc_13", "pa_inc_14", "pa_inc_15", 
             "pa_inc_16","pa_inc_17")

oth_inc <- c("oth_inc_0", "oth_inc_1", "oth_inc_2", "oth_inc_3", 
             "oth_inc_4", "oth_inc_5", "oth_inc_6", "oth_inc_7", 
             "oth_inc_8", "oth_inc_9", "oth_inc_10", "oth_inc_11",
             "oth_inc_12", "oth_inc_13", "oth_inc_14", "oth_inc_15", 
             "oth_inc_16","oth_inc_17")



```

# Version 1: Baseline

1.  Filter who born in 1968

```{r eval=FALSE}
a68 <- fda_data %>%
  filter(birth_year_int %in% 1968)

a68 <- a68[, c(1:30, 64:133)]


old_names <- as.character(1968:1988)
new_names <- paste0("fa_inc_", 0:20)
# rename income rows
names(a68)[names(a68) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:20) 

a68 <- a68 %>%
  filter(!(rowSums(across(all_of(inc_var), ~ . == 0)) == 
             length(inc_var) &
           rowSums(across(all_of(r_xx), ~ . == 0)) == length(r_xx)))

a68 <- a68 %>%
filter(rowSums(across(all_of(r_xx), ~ . 
                      == 0 | (. >= 30 & . <= 38))) >= 1)

```

## Combination of the data frame

```{r eval=FALSE}
T <- bind_rows(a69, a70, a71, a72, a73, a74, a75, 
               a76, a77, a78, a79, a80, a81, a82, 
               a83, a84, a85, a86, a87, a88, a89, 
               a90, a91, a92, a93, a94, a95, a96, 
               a97, a98, a99, a00)

T <- T %>%
select(ID, sex, birth_year, age_end_2021, Wtr_sample, Wtr_responding,
       age_at_first_birth,
       No_birth_in_recently_updated_year,first_child_born,
       year_birth_info_most_recently_updated,had_children_before_2021,
      all_of(inc_var), all_of(r_xx),all_of(sequence_vars), everything())

T2 <- T[apply(T[income_columns], 1, function(row) {
  all(!is.na(row))
}), ]


```

### Select ER32006(Wtr_sample)，ensure our data is in sample 1，2，3

1.  This individual is original sample (ER30002=001-026)
2.  This individual is born-in sample (ER30002=030-169)
3.  This individual is moved-in sample

Data count summary

| Value | Wtr_sample | Explanation |
|-------------------|-------------------|----------------------------------|
| 0 | 8216 | This individual is nonsample and not part of the elderly group |
| 1 | 3556 | This individual is an original sample |
| 2 | 8020 | This individual is born-in sample |
| 3 | 1173 | This individual is moved-in sample |
| 4 | 89 | This individual is joint inclusion sample |
| 5 | 704 | This individual was a followable nonsample parent |
| 6 | 1 | This individual is a nonsample elderly |

| Value | Wtr_responding | Meaning                   |
|-------|----------------|---------------------------|
| 0     | 376            | Core always               |
| 1     | 16753          | Core not always           |
| 2     | 274            | Latino or Immi always     |
| 3     | 4356           | Latino or Immi not always |

### Data outline

1.  **There are 4802 families in the original wave and extend to 32824
    family units in current version**

2.  **There are 84121 individuals in collection and for filter T data we
    have 21759 individuals, 25.9% of the all samples**

3.  **There are 11125 individuals can be tracked from age 0-20**

4.  **There are 10884 individuals not total lose the child birth
    information**

5.  **birth history is the summation of the data**

### Gender Distribution Table

Below is the distribution of gender with the corresponding counts:

| Gender | Count |
|--------|-------|
| Male   | 11518 |
| Female | 10241 |

### Frequency Table for `Wtr_responding` in T3

| Value | Count |
|-------|-------|
| 0     | 258   |
| 1     | 10544 |
| 2     | 7     |
| 3     | 75    |

### Frequency Table for `Wtr_sample` in T3

| Value | Count |
|-------|-------|
| 0     | 4546  |
| 1     | 23    |
| 2     | 5439  |
| 3     | 349   |
| 4     | 37    |
| 5     | 490   |

# Version 2

For this version, the structure and data range is changed compared with
Version 1, the main points are below:

-   The family income time range reduce to 17, means tracking
    individuals family incomes from they born to age 17. (Time period is
    0-17 years)

-   Filter the individuals data who does not change their family status
    at age 17.

-   Try to add wealth variables in our dataframe.

## Filter the individuals whose relation to the head variable is between 30-38 or 0 at age 17

This step need to filter the data year by year.

So we need b68-b00 to indicate the selection from each wave.

Cut the variables from fa_inc_18 to fa_inc_20

```{r eval=FALSE}
b68 <- fda_data %>%
  filter(birth_year_int %in% 1968)

b68 <- b68[, c(1:27, 64:133)]

old_names <- as.character(1968:1985)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b68)[names(b68) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes

b68 <- b68 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17

b68 <- b68 %>%
  filter(R_85 == 0 | (R_85 >= 30 & R_85 <= 38))

```

## Continue b69

```{r eval=FALSE}
b69 <- fda_data %>%
  filter(birth_year_int %in% 1969)

b69 <- b69[, c(1:9,11:28,64:133)]

old_names <- as.character(1969:1986)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b69)[names(b69) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes

b69 <- b69 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17

b69 <- b69 %>%
  filter(R_86 == 0 | (R_86 >= 30 & R_86 <= 38))
```

### b70-b81

```{r eval=FALSE}
# b70
b70 <- fda_data %>%
  filter(birth_year_int %in% 1970)

b70 <- b70[, c(1:9,12:29,64:133)]

old_names <- as.character(1970:1987)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b70)[names(b70) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b70 <- b70 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b70 <- b70 %>%
  filter(R_87 == 0 | (R_87 >= 30 & R_87 <= 38))


# b71
b71 <- fda_data %>%
  filter(birth_year_int %in% 1971)

b71 <- b71[, c(1:9,13:30,64:133)]

old_names <- as.character(1971:1988)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b71)[names(b71) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b71 <- b71 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ . == 0)) == length(income_columns)))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b71 <- b71 %>%
  filter(R_88 == 0 | (R_88 >= 30 & R_88 <= 38))


# b72
b72 <- fda_data %>%
  filter(birth_year_int %in% 1972)

b72 <- b72[, c(1:9,14:31,64:133)]

old_names <- as.character(1972:1989)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b72)[names(b72) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b72 <- b72 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b72 <- b72 %>%
  filter(R_89 == 0 | (R_89 >= 30 & R_89 <= 38))


# b73
b73 <- fda_data %>%
  filter(birth_year_int %in% 1973)

b73 <- b73[, c(1:9,15:32,64:133)]

old_names <- as.character(1973:1990)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b73)[names(b73) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b73 <- b73 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b73 <- b73 %>%
  filter(R_90 == 0 | (R_90 >= 30 & R_90 <= 38))


# b74
b74 <- fda_data %>%
  filter(birth_year_int %in% 1974)

b74 <- b74[, c(1:9,16:33,64:133)]

old_names <- as.character(1974:1991)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b74)[names(b74) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b74 <- b74 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b74 <- b74 %>%
  filter(R_91 == 0 | (R_91 >= 30 & R_91 <= 38))


# b75
b75 <- fda_data %>%
  filter(birth_year_int %in% 1975)

b75 <- b75[, c(1:9,17:34,64:133)]

old_names <- as.character(1975:1992)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b75)[names(b75) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b75 <- b75 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b75 <- b75 %>%
  filter(R_92 == 0 | (R_92 >= 30 & R_92 <= 38))


# b76
b76 <- fda_data %>%
  filter(birth_year_int %in% 1976)

b76 <- b76[, c(1:9,18:35,64:133)]

old_names <- as.character(1976:1993)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b76)[names(b76) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b76 <- b76 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b76 <- b76 %>%
  filter(R_93 == 0 | (R_93 >= 30 & R_93 <= 38))


# b77
b77 <- fda_data %>%
  filter(birth_year_int %in% 1977)

b77 <- b77[, c(1:9,19:36,64:133)]

old_names <- as.character(1977:1994)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b77)[names(b77) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b77 <- b77 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b77 <- b77 %>%
  filter(R_94 == 0 | (R_94 >= 30 & R_94 <= 38))


# b78
b78 <- fda_data %>%
  filter(birth_year_int %in% 1978)

b78 <- b78[, c(1:9,20:37,64:133)]

old_names <- as.character(1978:1995)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b78)[names(b78) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b78 <- b78 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b78 <- b78 %>%
  filter(R_95 == 0 | (R_95 >= 30 & R_95 <= 38))

# b79
b79 <- fda_data %>%
  filter(birth_year_int %in% 1979)

b79 <- b79[, c(1:9,21:38,64:133)]

old_names <- as.character(1979:1996)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b79)[names(b79) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b79 <- b79 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b79 <- b79 %>%
  filter(R_96 == 0 | (R_96 >= 30 & R_96 <= 38))


# b80
b80 <- fda_data %>%
  filter(birth_year_int %in% 1980)

b80 <- b80[, c(1:9,22:39,64:133)]

old_names <- as.character(1980:1997)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b80)[names(b80) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b80 <- b80 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b80 <- b80 %>%
  filter(R_97 == 0 | (R_97 >= 30 & R_97 <= 38))


# b81
b81 <- fda_data %>%
  filter(birth_year_int %in% 1981)

b81 <- b81[, c(1:9,23:40,64:133)]

old_names <- as.character(1981:1998)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b81)[names(b81) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b81 <- b81 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b81 <- b81 %>%
  filter(R_99 == 0 | (R_99 >= 30 & R_99 <= 38))
```

### b82-b91

```{r eval=FALSE}
# b82
b82 <- fda_data %>%
  filter(birth_year_int %in% 1982)

b82 <- b82[, c(1:9,24:41,64:133)]

old_names <- as.character(1982:1999)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b82)[names(b82) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b82 <- b82 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b82 <- b82 %>%
  filter(R_99 == 0 | (R_99 >= 30 & R_99 <= 38))

# b83
b83 <- fda_data %>%
  filter(birth_year_int %in% 1983)

b83 <- b83[, c(1:9,25:42,64:133)]

old_names <- as.character(1983:2000)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b83)[names(b83) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b83 <- b83 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b83 <- b83 %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))


# b84
b84 <- fda_data %>%
  filter(birth_year_int %in% 1984)

b84 <- b84[, c(1:9,26:43,64:133)]

old_names <- as.character(1984:2001)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b84)[names(b84) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b84 <- b84 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b84 <- b84 %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))


# b85
b85 <- fda_data %>%
  filter(birth_year_int %in% 1985)

b85 <- b85[, c(1:9,27:44,64:133)]

old_names <- as.character(1985:2002)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b85)[names(b85) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b85 <- b85 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b85 <- b85 %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))


# b86
b86 <- fda_data %>%
  filter(birth_year_int %in% 1986)

b86 <- b86[, c(1:9,28:45,64:133)]

old_names <- as.character(1986:2003)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b86)[names(b86) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b86 <- b86 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b86 <- b86 %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))


# b87
b87 <- fda_data %>%
  filter(birth_year_int %in% 1987)

b87 <- b87[, c(1:9,29:46,64:133)]

old_names <- as.character(1987:2004)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b87)[names(b87) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b87 <- b87 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b87 <- b87 %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))


# b88
b88 <- fda_data %>%
  filter(birth_year_int %in% 1988)

b88 <- b88[, c(1:9,30:47,64:133)]

old_names <- as.character(1988:2005)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b88)[names(b88) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b88 <- b88 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b88 <- b88 %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))


# b89
b89 <- fda_data %>%
  filter(birth_year_int %in% 1989)

b89 <- b89[, c(1:9,31:48,64:133)]

old_names <- as.character(1989:2006)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b89)[names(b89) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b89 <- b89 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b89 <- b89 %>%
  filter(R_07 == 0 | (R_07 >= 30 & R_07 <= 38))


# b90
b90 <- fda_data %>%
  filter(birth_year_int %in% 1990)

b90 <- b90[, c(1:9,32:49,64:133)]

old_names <- as.character(1990:2007)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b90)[names(b90) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b90 <- b90 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b90 <- b90 %>%
  filter(R_07 == 0 | (R_07 >= 30 & R_07 <= 38))


# b91
b91 <- fda_data %>%
  filter(birth_year_int %in% 1991)

b91 <- b91[, c(1:9,33:50,64:133)]

old_names <- as.character(1991:2008)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b91)[names(b91) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b91 <- b91 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b91 <- b91 %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))
```

### b92-b00

```{r eval=FALSE}
# b92
b92 <- fda_data %>%
  filter(birth_year_int %in% 1992)

b92 <- b92[, c(1:9,34:51,64:133)]

old_names <- as.character(1992:2009)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b92)[names(b92) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b92 <- b92 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b92 <- b92 %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))


# b93
b93 <- fda_data %>%
  filter(birth_year_int %in% 1993)

b93 <- b93[, c(1:9,35:52,64:133)]

old_names <- as.character(1993:2010)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b93)[names(b93) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b93 <- b93 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b93 <- b93 %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))


# b94
b94 <- fda_data %>%
  filter(birth_year_int %in% 1994)

b94 <- b94[, c(1:9,36:53,64:133)]

old_names <- as.character(1994:2011)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b94)[names(b94) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b94 <- b94 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b94 <- b94 %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))


# b95
b95 <- fda_data %>%
  filter(birth_year_int %in% 1995)

b95 <- b95[, c(1:9,37:54,64:133)]

old_names <- as.character(1995:2012)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b95)[names(b95) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b95 <- b95 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b95 <- b95 %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))


# b96
b96 <- fda_data %>%
  filter(birth_year_int %in% 1996)

b96 <- b96[, c(1:9,38:55,64:133)]

old_names <- as.character(1996:2013)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b96)[names(b96) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b96 <- b96 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b96 <- b96 %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))


# b97
b97 <- fda_data %>%
  filter(birth_year_int %in% 1997)

b97 <- b97[, c(1:9,39:56,64:133)]

old_names <- as.character(1997:2014)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b97)[names(b97) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b97 <- b97 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b97 <- b97 %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))


# b98
b98 <- fda_data %>%
  filter(birth_year_int %in% 1998)

b98 <- b98[, c(1:9,40:57,64:133)]

old_names <- as.character(1998:2015)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b98)[names(b98) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b98 <- b98 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b98 <- b98 %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))


# b99
b99 <- fda_data %>%
  filter(birth_year_int %in% 1999)

b99 <- b99[, c(1:9,41:58,64:133)]

old_names <- as.character(1999:2016)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b99)[names(b99) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b99 <- b99 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b99 <- b99 %>%
  filter(R_17 == 0 | (R_17 >= 30 & R_17 <= 38))


# b00
b00 <- fda_data %>%
  filter(birth_year_int %in% 2000)

b00 <- b00[, c(1:9,42:59,64:133)]

old_names <- as.character(2000:2017)
new_names <- paste0("fa_inc_", 0:17)

# rename income rows
names(b00)[names(b00) %in% old_names] <- new_names
income_columns <- paste0("fa_inc_", 0:17) 

# Remove the individuals who can't track the family incomes
b00 <- b00 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

# Filter relation to the head variable is between 30-38 or 0 at age 17
b00 <- b00 %>%
  filter(R_17 == 0 | (R_17 >= 30 & R_17 <= 38))
```

## Combination of each wave

```{r eval=FALSE}
T4 <- bind_rows(
  b68, b69, b70, b71, b72, b73, b74, b75, b76, b77,
  b78, b79, b80, b81, b82, b83, b84, b85, b86, b87,
  b88, b89, b90, b91, b92, b93, b94, b95, b96, b97,
  b98, b99, b00
)


T4 <- T4 %>%
select(ID, sex, birth_year, age_end_2021, Wtr_sample, Wtr_responding,
       age_at_first_birth,
       No_birth_in_recently_updated_year,first_child_born,
       year_birth_info_most_recently_updated,had_children_before_2021,
      all_of(inc_var1), all_of(r_xx),all_of(sequence_vars), everything())


# remove the individuals who is followable nonsample parent or nonsample elderly. 

T4 <- T4 %>%
  filter(!(Wtr_sample %in% c(5, 6)))


## Remove filter variables
T4 <- T4 %>%
  select (-all_of(r_xx), -all_of(sequence_vars),-Wtr_sample)

```

# Version 3

For this version, the structure and data range is changed compared with
Version 1, the main points are below:

-   Double check the individuals birth date by age variables

<!-- -->

-   Generate variable for number of people or dependents in household

<!-- -->

-   Adjust lower threshold fertility from 20 to 15

<!-- -->

-   Produce table of dropped variables due to family income missing 

```{r eval=FALSE}
b68 <- fda_data %>%
  filter(birth_year_int %in% 1968)

b68 <- b68[, c(1:32, 69:179)]

old_names <- as.character(1968:1985)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b68)[names(b68) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n68<- nrow(b68)

# Remove the individuals who can't track the family incomes

b68i <- b68 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n68i<-nrow(b68i)

# Filter relation to the head variable is between 30-38 or 0 at age 17

b68h <- b68i %>%
  filter(R_85 == 0 | (R_85 >= 30 & R_85 <= 38))

n68h <-nrow(b68h)

```

```{r eval=FALSE}
b68 <- fda_data %>%
  filter(birth_year_int %in% 1968)

b68 <- b68[, c(1:32, 69:179)]

old_names <- as.character(1968:1985)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b68)[names(b68) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n68<- nrow(b68)

# Remove the individuals who can't track the family incomes

b68i <- b68 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n68i<-nrow(b68i)

# Filter relation to the head variable is between 30-38 or 0 at age 17

b68h <- b68i %>%
  filter(R_85 == 0 | (R_85 >= 30 & R_85 <= 38))

n68h <-nrow(b68h)

```

## Continue b69

```{r}
b69 <- fda_data %>%
  filter(birth_year_int %in% 1969)

b69 <- b69[, c(1:14,16:33, 69:179)]

old_names <- as.character(1969:1986)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b69)[names(b69) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n69<- nrow(b69)

# Remove the individuals who can't track the family incomes

b69i <- b69 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n69i<-nrow(b69i)

# Filter relation to the head variable is between 30-38 or 0 at age 17

b69h <- b69i %>%
  filter(R_85 == 0 | (R_85 >= 30 & R_85 <= 38))

n69h <-nrow(b69h)

```

### b70-b81

```{r}
b70 <- fda_data %>%
  filter(birth_year_int %in% 1970)

b70 <- b70[, c(1:14,17:34, 69:179)]

old_names <- as.character(1970:1987)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b70)[names(b70) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n70 <- nrow(b70)

# Remove the individuals who can't track the family incomes
b70i <- b70 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n70i <- nrow(b70i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b70h <- b70i %>%
  filter(R_86 == 0 | (R_86 >= 30 & R_86 <= 38))

n70h <- nrow(b70h)


b71 <- fda_data %>%
  filter(birth_year_int %in% 1971)

b71 <- b71[, c(1:14,18:35, 69:179)]

old_names <- as.character(1971:1988)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b71)[names(b71) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n71 <- nrow(b71)

# Remove the individuals who can't track the family incomes
b71i <- b71 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n71i <- nrow(b71i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b71h <- b71i %>%
  filter(R_87 == 0 | (R_87 >= 30 & R_87 <= 38))

n71h <- nrow(b71h)



b72 <- fda_data %>%
  filter(birth_year_int %in% 1972)

b72 <- b72[, c(1:14,19:36, 69:179)]

old_names <- as.character(1972:1989)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b72)[names(b72) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n72 <- nrow(b72)

# Remove the individuals who can't track the family incomes
b72i <- b72 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n72i <- nrow(b72i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b72h <- b72i %>%
  filter(R_88 == 0 | (R_88 >= 30 & R_88 <= 38))

n72h <- nrow(b72h)


b73 <- fda_data %>%
  filter(birth_year_int %in% 1973)

b73 <- b73[, c(1:14,20:37, 69:179)]

old_names <- as.character(1973:1990)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b73)[names(b73) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n73 <- nrow(b73)

# Remove the individuals who can't track the family incomes
b73i <- b73 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n73i <- nrow(b73i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b73h <- b73i %>%
  filter(R_89 == 0 | (R_89 >= 30 & R_89 <= 38))

n73h <- nrow(b73h)


b74 <- fda_data %>%
  filter(birth_year_int %in% 1974)

b74 <- b74[, c(1:14,21:38, 69:179)]

old_names <- as.character(1974:1991)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b74)[names(b74) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n74 <- nrow(b74)

# Remove the individuals who can't track the family incomes
b74i <- b74 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n74i <- nrow(b74i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b74h <- b74i %>%
  filter(R_90 == 0 | (R_90 >= 30 & R_90 <= 38))

n74h <- nrow(b74h)



b75 <- fda_data %>%
  filter(birth_year_int %in% 1975)

b75 <- b75[, c(1:14,22:39, 69:179)]

old_names <- as.character(1975:1992)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b75)[names(b75) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n75 <- nrow(b75)

# Remove the individuals who can't track the family incomes
b75i <- b75 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n75i <- nrow(b75i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b75h <- b75i %>%
  filter(R_91 == 0 | (R_91 >= 30 & R_91 <= 38))

n75h <- nrow(b75h)



b76 <- fda_data %>%
  filter(birth_year_int %in% 1976)

b76 <- b76[, c(1:14,23:40, 69:179)]

old_names <- as.character(1976:1993)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b76)[names(b76) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n76 <- nrow(b76)

# Remove the individuals who can't track the family incomes
b76i <- b76 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n76i <- nrow(b76i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b76h <- b76i %>%
  filter(R_92 == 0 | (R_92 >= 30 & R_92 <= 38))

n76h <- nrow(b76h)



b77 <- fda_data %>%
  filter(birth_year_int %in% 1977)

b77 <- b77[, c(1:14,24:41, 69:179)]

old_names <- as.character(1977:1994)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b77)[names(b77) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n77 <- nrow(b77)

# Remove the individuals who can't track the family incomes
b77i <- b77 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n77i <- nrow(b77i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b77h <- b77i %>%
  filter(R_93 == 0 | (R_93 >= 30 & R_93 <= 38))

n77h <- nrow(b77h)


b78 <- fda_data %>%
  filter(birth_year_int %in% 1978)

b78 <- b78[, c(1:14,25:42, 69:179)]

old_names <- as.character(1978:1995)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b78)[names(b78) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n78 <- nrow(b78)

# Remove the individuals who can't track the family incomes
b78i <- b78 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n78i <- nrow(b78i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b78h <- b78i %>%
  filter(R_94 == 0 | (R_94 >= 30 & R_94 <= 38))

n78h <- nrow(b78h)


b79 <- fda_data %>%
  filter(birth_year_int %in% 1979)

b79 <- b79[, c(1:14,26:43, 69:179)]

old_names <- as.character(1979:1996)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b79)[names(b79) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n79 <- nrow(b79)

# Remove the individuals who can't track the family incomes
b79i <- b79 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n79i <- nrow(b79i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b79h <- b79i %>%
  filter(R_95 == 0 | (R_95 >= 30 & R_95 <= 38))

n79h <- nrow(b79h)



b80 <- fda_data %>%
  filter(birth_year_int %in% 1980)

b80 <- b80[, c(1:14,27:44, 69:179)]

old_names <- as.character(1980:1997)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b80)[names(b80) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n80 <- nrow(b80)

# Remove the individuals who can't track the family incomes
b80i <- b80 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n80i <- nrow(b80i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b80h <- b80i %>%
  filter(R_96 == 0 | (R_96 >= 30 & R_96 <= 38))

n80h <- nrow(b80h)




b81 <- fda_data %>%
  filter(birth_year_int %in% 1981)

b81 <- b81[, c(1:14,28:45, 69:179)]

old_names <- as.character(1981:1998)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b81)[names(b81) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n81 <- nrow(b81)

# Remove the individuals who can't track the family incomes
b81i <- b81 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n81i <- nrow(b81i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b81h <- b81i %>%
  filter(R_97 == 0 | (R_97 >= 30 & R_97 <= 38))

n81h <- nrow(b81h)
```

### b82-b91

```{r}
b82 <- fda_data %>%
  filter(birth_year_int %in% 1982)

b82 <- b82[, c(1:14,29:46, 69:179)]

old_names <- as.character(1982:1999)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b82)[names(b82) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n82 <- nrow(b82)

# Remove the individuals who can't track the family incomes
b82i <- b82 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n82i <- nrow(b82i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b82h <- b82i %>%
  filter(R_99 == 0 | (R_99 >= 30 & R_99 <= 38))

n82h <- nrow(b82h)



b83 <- fda_data %>%
  filter(birth_year_int %in% 1983)

b83 <- b83[, c(1:14,30:47, 69:179)]

old_names <- as.character(1983:2000)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b83)[names(b83) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n83 <- nrow(b83)

# Remove the individuals who can't track the family incomes
b83i <- b83 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n83i <- nrow(b83i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b83h <- b83i %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))

n83h <- nrow(b83h)



b84 <- fda_data %>%
  filter(birth_year_int %in% 1984)

b84 <- b84[, c(1:14,31:48, 69:179)]

old_names <- as.character(1984:2001)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b84)[names(b84) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n84 <- nrow(b84)

# Remove the individuals who can't track the family incomes
b84i <- b84 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n84i <- nrow(b84i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b84h <- b84i %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))

n84h <- nrow(b84h)



b85 <- fda_data %>%
  filter(birth_year_int %in% 1985)

b85 <- b85[, c(1:14,32:49, 69:179)]

old_names <- as.character(1985:2002)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b85)[names(b85) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n85 <- nrow(b85)

# Remove the individuals who can't track the family incomes
b85i <- b85 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n85i <- nrow(b85i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b85h <- b85i %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))

n85h <- nrow(b85h)


b86 <- fda_data %>%
  filter(birth_year_int %in% 1986)

b86 <- b86[, c(1:14,33:50, 69:179)]

old_names <- as.character(1986:2003)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b86)[names(b86) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n86 <- nrow(b86)

# Remove the individuals who can't track the family incomes
b86i <- b86 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n86i <- nrow(b86i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b86h <- b86i %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))

n86h <- nrow(b86h)




b87 <- fda_data %>%
  filter(birth_year_int %in% 1987)

b87 <- b87[, c(1:14,34:51, 69:179)]

old_names <- as.character(1987:2004)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b87)[names(b87) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n87 <- nrow(b87)

# Remove the individuals who can't track the family incomes
b87i <- b87 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n87i <- nrow(b87i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b87h <- b87i %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))

n87h <- nrow(b87h)


b88 <- fda_data %>%
  filter(birth_year_int %in% 1988)

b88 <- b88[, c(1:14,35:52, 69:179)]

old_names <- as.character(1988:2005)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b88)[names(b88) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n88 <- nrow(b88)

# Remove the individuals who can't track the family incomes
b88i <- b88 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n88i <- nrow(b88i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b88h <- b88i %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))

n88h <- nrow(b88h)

b89 <- fda_data %>%
  filter(birth_year_int %in% 1989)

b89 <- b89[, c(1:14,36:53, 69:179)]

old_names <- as.character(1989:2006)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b89)[names(b89) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n89 <- nrow(b89)

# Remove the individuals who can't track the family incomes
b89i <- b89 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n89i <- nrow(b89i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b89h <- b89i %>%
  filter(R_07 == 0 | (R_07  >= 30 & R_07  <= 38))

n89h <- nrow(b89h)


b90 <- fda_data %>%
  filter(birth_year_int %in% 1990)

b90 <- b90[, c(1:14,37:54, 69:179)]

old_names <- as.character(1990:2007)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b90)[names(b90) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n90 <- nrow(b90)

# Remove the individuals who can't track the family incomes
b90i <- b90 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n90i <- nrow(b90i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b90h <- b90i %>%
  filter(R_07 == 0 | (R_07 >= 30 & R_07 <= 38))

n90h <- nrow(b90h)


b91 <- fda_data %>%
  filter(birth_year_int %in% 1991)

b91 <- b91[, c(1:14,38:55, 69:179)]

old_names <- as.character(1991:2008)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b91)[names(b91) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n91 <- nrow(b91)

# Remove the individuals who can't track the family incomes
b91i <- b91 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n91i <- nrow(b91i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b91h <- b91i %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))

n91h <- nrow(b91h)
```

### b92-b00

```{r}
b92 <- fda_data %>%
  filter(birth_year_int %in% 1992)

b92 <- b92[, c(1:14,39:56, 69:179)]

old_names <- as.character(1992:2009)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b92)[names(b92) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n92 <- nrow(b92)

# Remove the individuals who can't track the family incomes
b92i <- b92 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n92i <- nrow(b92i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b92h <- b92i %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))

n92h <- nrow(b92h)


b93 <- fda_data %>%
  filter(birth_year_int %in% 1993)

b93 <- b93[, c(1:14,40:57, 69:179)]

old_names <- as.character(1993:2010)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b93)[names(b93) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n93 <- nrow(b93)

# Remove the individuals who can't track the family incomes
b93i <- b93 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n93i <- nrow(b93i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b93h <- b93i %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))

n93h <- nrow(b93h)

b94 <- fda_data %>%
  filter(birth_year_int %in% 1994)

b94 <- b94[, c(1:14,41:58, 69:179)]

old_names <- as.character(1994:2011)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b94)[names(b94) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n94 <- nrow(b94)

# Remove the individuals who can't track the family incomes
b94i <- b94 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n94i <- nrow(b94i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b94h <- b94i %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))

n94h <- nrow(b94h)


b95 <- fda_data %>%
  filter(birth_year_int %in% 1995)

b95 <- b95[, c(1:14,42:59, 69:179)]

old_names <- as.character(1995:2012)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b95)[names(b95) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n95 <- nrow(b95)

# Remove the individuals who can't track the family incomes
b95i <- b95 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n95i <- nrow(b95i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b95h <- b95i %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))

n95h <- nrow(b95h)

b96 <- fda_data %>%
  filter(birth_year_int %in% 1996)

b96 <- b96[, c(1:14,43:60, 69:179)]

old_names <- as.character(1996:2013)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b96)[names(b96) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n96 <- nrow(b96)

# Remove the individuals who can't track the family incomes
b96i <- b96 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n96i <- nrow(b96i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b96h <- b96i %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))

n96h <- nrow(b96h)


b97 <- fda_data %>%
  filter(birth_year_int %in% 1997)

b97 <- b97[, c(1:14,44:61, 69:179)]

old_names <- as.character(1997:2014)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b97)[names(b97) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n97 <- nrow(b97)

# Remove the individuals who can't track the family incomes
b97i <- b97 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n97i <- nrow(b97i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b97h <- b97i %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))

n97h <- nrow(b97h)


b98 <- fda_data %>%
  filter(birth_year_int %in% 1998)

b98 <- b98[, c(1:14,45:62, 69:179)]

old_names <- as.character(1998:2015)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b98)[names(b98) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n98 <- nrow(b98)

# Remove the individuals who can't track the family incomes
b98i <- b98 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n98i <- nrow(b98i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b98h <- b98i %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))

n98h <- nrow(b98h)


b99 <- fda_data %>%
  filter(birth_year_int %in% 1999)

b99 <- b99[, c(1:14,46:63, 69:179)]

old_names <- as.character(1999:2016)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b99)[names(b99) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n99 <- nrow(b99)

# Remove the individuals who can't track the family incomes
b99i <- b99 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n99i <- nrow(b99i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b99h <- b99i %>%
  filter(R_17 == 0 | (R_17 >= 30 & R_17 <= 38))

n99h <- nrow(b99h)


b00 <- fda_data %>%
  filter(birth_year_int %in% 2000)

b00 <- b00[, c(1:14,47:64, 69:179)]

old_names <- as.character(2000:2017)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b00)[names(b00) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n00 <- nrow(b00)

# Remove the individuals who can't track the family incomes
b00i <- b00 %>%
  filter(!(rowSums(across(all_of(income_columns), ~ is.na(.) | . < 0)) > 0))

n00i <- nrow(b00i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b00h <- b00i %>%
  filter(R_17 == 0 | (R_17 >= 30 & R_17 <= 38))

n00h <- nrow(b00h)
```

## Combination of each wave

```{r}
T5 <- bind_rows(
  b68h, b69h, b70h, b71h, b72h, b73h, b74h, b75h, b76h, b77h,
  b78h, b79h, b80h, b81h, b82h, b83h, b84h, b85h, b86h, b87h,
  b88h, b89h, b90h, b91h, b92h, b93h, b94h, b95h, b96h, b97h,
  b98h, b99h, b00h
)


T5 <- T5 %>%
 select(ID, sex, birth_year, age_end_2021, 
         Birth_Order_to_Father, 
         Total_Children_Born_to_Father, 
         Birth_Order_to_Mother, 
         Marital_Status_of_Mother_at_Birth, 
         Total_Children_Born_to_Mother,
         age_at_first_birth,
         No_birth_in_recently_updated_year,
         first_child_born,
         year_birth_info_most_recently_updated, 
         had_children_before_2021,Wtr_sample,all_of(par_inc))

NT5<- nrow(T5)

# remove the individuals who is followable nonsample parent or nonsample elderly. 

T5i <- T5 %>%
  filter(!(Wtr_sample %in% c(5, 6)))

## Remove filter variables
T5i <- T5i %>%
  select (-Wtr_sample)

NT5i <- nrow(T5i)


N<- c ( "n68", "n69", "n70", "n71", "n72", "n73", "n74", "n75", "n76", "n77",
  "n78", "n79", "n80", "n81", "n82", "n83", "n84", "n85", "n86", "n87",
  "n88", "n89", "n90", "n91", "n92", "n93", "n94", "n95", "n96", "n97",
  "n98", "n99", "n00")

NW <- c(
  n68, n69, n70, n71, n72, n73, n74, n75, n76, n77, n78, n79, n80, n81, n82, n83, n84, n85, n86, n87, n88, n89, n90, n91, n92, n93, n94, n95, n96, n97, n98, n99, n00
)


NWi <- c(
n68i, n69i, n70i, n71i, n72i, n73i, n74i, n75i, n76i, n77i, n78i, n79i, n80i, n81i, n82i, n83i, n84i, n85i, n86i, n87i, n88i, n89i, n90i, n91i, n92i, n93i, n94i, n95i, n96i, n97i, n98i, n99i, n00i
)

NWh <- c(
n68h, n69h, n70h, n71h, n72h, n73h, n74h, n75h, n76h, n77h, n78h, n79h, n80h, n81h, n82h, n83h, n84h, n85h, n86h, n87h, n88h, n89h, n90h, n91h, n92h, n93h, n94h, n95h, n96h, n97h, n98h, n99h, n00h
)


NumberData <- data.frame(
  N = N,
  NW = NW,
  NWi = NWi,
  NWh = NWh,
  stringsAsFactors = FALSE
)


rownames(NumberData) <- NULL

data_transposed <- t(NumberData)



data_transposed_df <- as.data.frame(data_transposed, stringsAsFactors = FALSE)


colnames(data_transposed_df) <- c("N", "NW", "NWi", "NWh")




print(data_transposed_df)


write.xlsx(NumberData, file = "NumberData.xlsx")
```

## Version 4

1.  **Summary of Observations with Missing Income Data**:
    -   **Total Observations**: Calculate the total number of
        observations.
    -   **Missing Income Years**: For each observation, count how many
        years have missing income values (from 0 to 17 years).
        -   Create a table that shows the number of observations with 1,
            2, 3, etc. years of missing income values.
    -   **Zero-Income Years**: Similarly, count how many years have
        zero-income values.
        -   Produce a table showing the number of observations with 1,
            2, 3, etc. years of zero-income.
2.  **Handling Missing Income Data**:
    -   **Dropping Observations**: Drop any observations where 6 or more
        income years are missing.
    -   **Imputation of Missing/Zero-Income Values**:
        -   For the remaining observations, if a year has a missing or
            zero-income value, impute it.

        -   The imputed value for year t (and subsequent years if
            missing) should be the mean of the first observed income
            value before year t and the first observed income value
            after year t.

        -   For example, if year t and t+1 incomes are missing but you
            observe income for year t-1 and year t+2, then:

            $$\text{inc}_t = \text{inc}_{t+1} = \frac{\text{inc}_{t-1} + \text{inc}_{t+2}}{2}$$
3.  **Creating Alternative Family Income Measures**:
    -   **Base Income Measure (inc_t)**: Use the imputed income values
        from the previous step as the base measure.
    -   Generate three additional income measures:
        1.  **Log Income**: $\ln(\text{inc}_t)$
        2.  **Relative Income to Mean**:
            $\ln(\text{inc}_t) - \ln(\text{mean}_{t=0\ to\ t=17})(\text{inc}_t)$
        3.  **Proportional Income**:
            $\frac{\text{inc}_t}{\sum_{t=0}^{t=17} \text{inc}_t}$
4.  **Plotting Income Trajectories**:
    -   **Trajectories for Each Measure**: Plot the income trajectories
        for each of the four income measures (the base measure and the
        three derived measures).
    -   **Subsample if Necessary**: If the data is too dense, use a
        random subsample for visualization.

### Processing the waves

```{r}
##remove family income data

fda_data<- select(fda_data, -one_of(all_year))

```

```{r eval=FALSE}
b68 <- fda_data %>%
  filter(birth_year_int %in% 1968)

b68 <- b68[, c(1:27, 64:133)]

old_names <- as.character(1968:1985)
new_names <- paste0("pa_inc_", 0:17)

#old_name <- as.character(21968:21985)
#new_name <- paste0("fa_inc_", 0:17)

# rename income rows
names(b68)[names(b68) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

## names(b68)[names(b68) %in% old_name] <- new_name
## fa_income_columns <- paste0("fa_inc_", 0:17) 


n68<- nrow(b68)

# Remove the individuals who can't track the family incomes
# Remove individuals who have more than 12 missing or negative income values

b68i <- b68 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n68i<-nrow(b68i)

# Filter relation to the head variable is between 30-38 or 0 at age 17

b68h <- b68i %>%
  filter(R_85 == 0 | (R_85 >= 30 & R_85 <= 38))

n68h <-nrow(b68h)


### CPI standardized 

m68 <- b68h[,c(income_columns)]
b68c<- m68*c68
b68h[income_columns] <- b68c
```

### Continue b69

```{r}
b69 <- fda_data %>%
  filter(birth_year_int %in% 1969)

b69 <- b69[, c(1:9,11:28, 64:133)]

old_names <- as.character(1969:1986)
new_names <- paste0("pa_inc_", 0:17)


# rename income rows
names(b69)[names(b69) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n69<- nrow(b69)

# Remove the individuals who can't track the family incomes

b69i <- b69 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n69i<-nrow(b69i)

# Filter relation to the head variable is between 30-38 or 0 at age 17

b69h <- b69i %>%
  filter(R_86 == 0 | (R_86 >= 30 & R_86 <= 38))

n69h <-nrow(b69h)


### CPI standardized 

m69 <- b69h[,c(income_columns)]
b69c<- m69*c69
b69h[income_columns] <- b69c

```

### b70-b81

```{r}
b70 <- fda_data %>%
  filter(birth_year_int %in% 1970)

b70 <- b70[, c(1:9,12:29, 64:133)]

old_names <- as.character(1970:1987)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b70)[names(b70) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n70 <- nrow(b70)

# Remove the individuals who can't track the family incomes
b70i <- b70 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n70i <- nrow(b70i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b70h <- b70i %>%
  filter(R_87 == 0 | (R_87 >= 30 & R_87 <= 38))

n70h <- nrow(b70h)

### CPI standardized 

m70 <- b70h[,c(income_columns)]
b70c<- m70*c70
b70h[income_columns] <- b70c




b71 <- fda_data %>%
  filter(birth_year_int %in% 1971)

b71 <- b71[, c(1:9,13:30, 64:133)]

old_names <- as.character(1971:1988)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b71)[names(b71) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n71 <- nrow(b71)

# Remove the individuals who can't track the family incomes
b71i <- b71 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n71i <- nrow(b71i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b71h <- b71i %>%
  filter(R_88 == 0 | (R_88 >= 30 & R_88 <= 38))

n71h <- nrow(b71h)

### CPI standardized 

m71 <- b71h[,c(income_columns)]
b71c<- m71*c71
b71h[income_columns] <- b71c



# For 1972 cohort
b72 <- fda_data %>%
  filter(birth_year_int %in% 1972)

b72 <- b72[, c(1:9,14:31, 64:133)]

old_names <- as.character(1972:1989)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b72)[names(b72) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n72 <- nrow(b72)

# Remove the individuals who can't track the family incomes
b72i <- b72 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n72i <- nrow(b72i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b72h <- b72i %>%
  filter(R_89 == 0 | (R_89 >= 30 & R_89 <= 38))

n72h <- nrow(b72h)

### CPI standardized 
m72 <- b72h[,c(income_columns)]
b72c <- m72*c72
b72h[income_columns] <- b72c

# For 1973 cohort
b73 <- fda_data %>%
  filter(birth_year_int %in% 1973)

b73 <- b73[, c(1:9,15:32, 64:133)]

old_names <- as.character(1973:1990)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b73)[names(b73) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n73 <- nrow(b73)

# Remove the individuals who can't track the family incomes
b73i <- b73 %>%
 filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n73i <- nrow(b73i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b73h <- b73i %>%
  filter(R_90 == 0 | (R_90 >= 30 & R_90 <= 38))

n73h <- nrow(b73h)

### CPI standardized 
m73 <- b73h[,c(income_columns)]
b73c <- m73*c73
b73h[income_columns] <- b73c

# For 1974 cohort
b74 <- fda_data %>%
  filter(birth_year_int %in% 1974)

b74 <- b74[, c(1:9,16:33, 64:133)]

old_names <- as.character(1974:1991)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b74)[names(b74) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n74 <- nrow(b74)

# Remove the individuals who can't track the family incomes
b74i <- b74 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n74i <- nrow(b74i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b74h <- b74i %>%
  filter(R_91 == 0 | (R_91 >= 30 & R_91 <= 38))

n74h <- nrow(b74h)

### CPI standardized 
m74 <- b74h[,c(income_columns)]
b74c <- m74*c74
b74h[income_columns] <- b74c

# For 1975 cohort
b75 <- fda_data %>%
  filter(birth_year_int %in% 1975)

b75 <- b75[, c(1:9,17:34, 64:133)]

old_names <- as.character(1975:1992)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b75)[names(b75) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n75 <- nrow(b75)

# Remove the individuals who can't track the family incomes
b75i <- b75 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n75i <- nrow(b75i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b75h <- b75i %>%
  filter(R_92 == 0 | (R_92 >= 30 & R_92 <= 38))

n75h <- nrow(b75h)

### CPI standardized 
m75 <- b75h[,c(income_columns)]
b75c <- m75*c75
b75h[income_columns] <- b75c

# For 1976 cohort
b76 <- fda_data %>%
  filter(birth_year_int %in% 1976)

b76 <- b76[, c(1:9,18:35, 64:133)]

old_names <- as.character(1976:1993)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b76)[names(b76) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n76 <- nrow(b76)

# Remove the individuals who can't track the family incomes
b76i <- b76 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n76i <- nrow(b76i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b76h <- b76i %>%
  filter(R_93 == 0 | (R_93 >= 30 & R_93 <= 38))

n76h <- nrow(b76h)

### CPI standardized 
m76 <- b76h[,c(income_columns)]
b76c <- m76*c76
b76h[income_columns] <- b76c

# For 1977 cohort
b77 <- fda_data %>%
  filter(birth_year_int %in% 1977)

b77 <- b77[, c(1:9,19:36, 64:133)]

old_names <- as.character(1977:1994)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b77)[names(b77) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n77 <- nrow(b77)

# Remove the individuals who can't track the family incomes
b77i <- b77 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n77i <- nrow(b77i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b77h <- b77i %>%
  filter(R_94 == 0 | (R_94 >= 30 & R_94 <= 38))

n77h <- nrow(b77h)

### CPI standardized 
m77 <- b77h[,c(income_columns)]
b77c <- m77*c77
b77h[income_columns] <- b77c

# For 1978 cohort
b78 <- fda_data %>%
  filter(birth_year_int %in% 1978)

b78 <- b78[, c(1:9,20:37, 64:133)]

old_names <- as.character(1978:1995)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b78)[names(b78) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n78 <- nrow(b78)

# Remove the individuals who can't track the family incomes
b78i <- b78 %>%
 filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n78i <- nrow(b78i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b78h <- b78i %>%
  filter(R_95 == 0 | (R_95 >= 30 & R_95 <= 38))

n78h <- nrow(b78h)

### CPI standardized 
m78 <- b78h[,c(income_columns)]
b78c <- m78*c78
b78h[income_columns] <- b78c

# For 1979 cohort
b79 <- fda_data %>%
  filter(birth_year_int %in% 1979)

b79 <- b79[, c(1:9,21:38, 64:133)]

old_names <- as.character(1979:1996)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b79)[names(b79) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n79 <- nrow(b79)

# Remove the individuals who can't track the family incomes
b79i <- b79 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n79i <- nrow(b79i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b79h <- b79i %>%
  filter(R_96 == 0 | (R_96 >= 30 & R_96 <= 38))

n79h <- nrow(b79h)

### CPI standardized 
m79 <- b79h[,c(income_columns)]
b79c <- m79*c79
b79h[income_columns] <- b79c

# For 1980 cohort
b80 <- fda_data %>%
  filter(birth_year_int %in% 1980)

b80 <- b80[, c(1:9,22:39, 64:133)]

old_names <- as.character(1980:1997)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b80)[names(b80) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n80 <- nrow(b80)

# Remove the individuals who can't track the family incomes
b80i <- b80 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n80i <- nrow(b80i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b80h <- b80i %>%
  filter(R_97 == 0 | (R_97 >= 30 & R_97 <= 38))

n80h <- nrow(b80h)

### CPI standardized 
m80 <- b80h[,c(income_columns)]
b80c <- m80*c80
b80h[income_columns] <- b80c

# For 1981 cohort
b81 <- fda_data %>%
  filter(birth_year_int %in% 1981)

b81 <- b81[, c(1:9,23:40, 64:133)]

old_names <- as.character(1981:1998)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b81)[names(b81) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n81 <- nrow(b81)

# Remove the individuals who can't track the family incomes
b81i <- b81 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n81i <- nrow(b81i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b81h <- b81i %>%
  filter(R_97 == 0 | (R_97 >= 30 & R_97 <= 38))

n81h <- nrow(b81h)

### CPI standardized 
m81 <- b81h[,c(income_columns)]
b81c <- m81*c81
b81h[income_columns] <- b81c
```

### b82-b91

```{r}
# For 1982 cohort
b82 <- fda_data %>%
  filter(birth_year_int %in% 1982)

b82 <- b82[, c(1:9,24:41, 64:133)]

old_names <- as.character(1982:1999)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b82)[names(b82) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n82 <- nrow(b82)

# Remove the individuals who can't track the family incomes
b82i <- b82 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n82i <- nrow(b82i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b82h <- b82i %>%
  filter(R_99 == 0 | (R_99 >= 30 & R_99 <= 38))

n82h <- nrow(b82h)

### CPI standardized 
m82 <- b82h[,c(income_columns)]
b82c <- m82*c82
b82h[income_columns] <- b82c

# For 1983 cohort
b83 <- fda_data %>%
  filter(birth_year_int %in% 1983)

b83 <- b83[, c(1:9,25:42, 64:133)]

old_names <- as.character(1983:2000)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b83)[names(b83) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n83 <- nrow(b83)

# Remove the individuals who can't track the family incomes
b83i <- b83 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n83i <- nrow(b83i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b83h <- b83i %>%
  filter(R_99 == 0 | (R_99 >= 30 & R_99 <= 38))

n83h <- nrow(b83h)

### CPI standardized 
m83 <- b83h[,c(income_columns)]
b83c <- m83*c83
b83h[income_columns] <- b83c



# For 1984 cohort
b84 <- fda_data %>%
  filter(birth_year_int %in% 1984)

b84 <- b84[, c(1:9,26:43, 64:133)]

old_names <- as.character(1984:2001)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b84)[names(b84) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n84 <- nrow(b84)

# Remove the individuals who can't track the family incomes
b84i <- b84 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n84i <- nrow(b84i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b84h <- b84i %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))

n84h <- nrow(b84h)

### CPI standardized 
m84 <- b84h[,c(income_columns)]
b84c <- m84*c84
b84h[income_columns] <- b84c

# For 1985 cohort
b85 <- fda_data %>%
  filter(birth_year_int %in% 1985)

b85 <- b85[, c(1:9,27:44, 64:133)]

old_names <- as.character(1985:2002)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b85)[names(b85) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n85 <- nrow(b85)

# Remove the individuals who can't track the family incomes
b85i <- b85 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n85i <- nrow(b85i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b85h <- b85i %>%
  filter(R_01 == 0 | (R_01 >= 30 & R_01 <= 38))

n85h <- nrow(b85h)

### CPI standardized 
m85 <- b85h[,c(income_columns)]
b85c <- m85*c85
b85h[income_columns] <- b85c

# For 1986 cohort
b86 <- fda_data %>%
  filter(birth_year_int %in% 1986)

b86 <- b86[, c(1:9,28:45, 64:133)]

old_names <- as.character(1986:2003)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b86)[names(b86) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n86 <- nrow(b86)

# Remove the individuals who can't track the family incomes
b86i <- b86 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n86i <- nrow(b86i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b86h <- b86i %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))

n86h <- nrow(b86h)

### CPI standardized 
m86 <- b86h[,c(income_columns)]
b86c <- m86*c86
b86h[income_columns] <- b86c

# For 1987 cohort
b87 <- fda_data %>%
  filter(birth_year_int %in% 1987)

b87 <- b87[, c(1:9,29:46, 64:133)]

old_names <- as.character(1987:2004)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b87)[names(b87) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n87 <- nrow(b87)

# Remove the individuals who can't track the family incomes
b87i <- b87 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n87i <- nrow(b87i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b87h <- b87i %>%
  filter(R_03 == 0 | (R_03 >= 30 & R_03 <= 38))

n87h <- nrow(b87h)

### CPI standardized 
m87 <- b87h[,c(income_columns)]
b87c <- m87*c87
b87h[income_columns] <- b87c

# For 1988 cohort
b88 <- fda_data %>%
  filter(birth_year_int %in% 1988)

b88 <- b88[, c(1:9,30:47, 64:133)]

old_names <- as.character(1988:2005)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b88)[names(b88) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n88 <- nrow(b88)

# Remove the individuals who can't track the family incomes
b88i <- b88 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n88i <- nrow(b88i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b88h <- b88i %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))

n88h <- nrow(b88h)

### CPI standardized 
m88 <- b88h[,c(income_columns)]
b88c <- m88*c88
b88h[income_columns] <- b88c

# For 1989 cohort
b89 <- fda_data %>%
  filter(birth_year_int %in% 1989)

b89 <- b89[, c(1:9,31:48, 64:133)]

old_names <- as.character(1989:2006)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b89)[names(b89) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n89 <- nrow(b89)

# Remove the individuals who can't track the family incomes
b89i <- b89 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n89i <- nrow(b89i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b89h <- b89i %>%
  filter(R_05 == 0 | (R_05 >= 30 & R_05 <= 38))

n89h <- nrow(b89h)

### CPI standardized 
m89 <- b89h[,c(income_columns)]
b89c <- m89*c89
b89h[income_columns] <- b89c

# For 1990 cohort
b90 <- fda_data %>%
  filter(birth_year_int %in% 1990)

b90 <- b90[, c(1:9,32:49, 64:133)]

old_names <- as.character(1990:2007)
new_names <- paste0("pa_inc_", 0:17)

# rename income rows
names(b90)[names(b90) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n90 <- nrow(b90)

# Remove the individuals who can't track the family incomes
b90i <- b90 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n90i <- nrow(b90i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b90h <- b90i %>%
  filter(R_07 == 0 | (R_07 >= 30 & R_07 <= 38))

n90h <- nrow(b90h)

### CPI standardized 
m90 <- b90h[,c(income_columns)]
b90c <- m90*c90
b90h[income_columns] <- b90c


# For 1991 cohort
b91 <- fda_data %>%
  filter(birth_year_int %in% 1991)

b91 <- b91[, c(1:9,33:50, 64:133)]

old_names <- as.character(1991:2008)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b91)[names(b91) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n91 <- nrow(b91)

# Remove the individuals who can't track the family incomes
b91i <- b91 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n91i <- nrow(b91i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b91h <- b91i %>%
  filter(R_07 == 0 | (R_07 >= 30 & R_07 <= 38))

n91h <- nrow(b91h)

### CPI standardized 
m91 <- b91h[, c(income_columns)]
b91c <- m91 * c91
b91h[income_columns] <- b91c
```

### b92-b00

```{r}
# For 1992 cohort
b92 <- fda_data %>%
  filter(birth_year_int %in% 1992)

b92 <- b92[, c(1:9,34:51, 64:133)]

old_names <- as.character(1992:2009)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b92)[names(b92) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n92 <- nrow(b92)

# Remove the individuals who can't track the family incomes
b92i <- b92 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n92i <- nrow(b92i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b92h <- b92i %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))

n92h <- nrow(b92h)

### CPI standardized 
m92 <- b92h[, c(income_columns)]
b92c <- m92 * c92
b92h[income_columns] <- b92c

# For 1993 cohort
b93 <- fda_data %>%
  filter(birth_year_int %in% 1993)

b93 <- b93[, c(1:9,35:52, 64:133)]

old_names <- as.character(1993:2010)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b93)[names(b93) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n93 <- nrow(b93)

# Remove the individuals who can't track the family incomes
b93i <- b93 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n93i <- nrow(b93i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b93h <- b93i %>%
  filter(R_09 == 0 | (R_09 >= 30 & R_09 <= 38))

n93h <- nrow(b93h)

### CPI standardized 
m93 <- b93h[, c(income_columns)]
b93c <- m93 * c93
b93h[income_columns] <- b93c

# For 1994 cohort
b94 <- fda_data %>%
  filter(birth_year_int %in% 1994)

b94 <- b94[, c(1:9,36:53, 64:133)]

old_names <- as.character(1994:2011)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b94)[names(b94) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n94 <- nrow(b94)

# Remove the individuals who can't track the family incomes
b94i <- b94 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n94i <- nrow(b94i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b94h <- b94i %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))

n94h <- nrow(b94h)

### CPI standardized 
m94 <- b94h[, c(income_columns)]
b94c <- m94 * c94
b94h[income_columns] <- b94c

# For 1995 cohort
b95 <- fda_data %>%
  filter(birth_year_int %in% 1995)

b95 <- b95[, c(1:9,37:54, 64:133)]

old_names <- as.character(1995:2012)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b95)[names(b95) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n95 <- nrow(b95)

# Remove the individuals who can't track the family incomes
b95i <- b95 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n95i <- nrow(b95i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b95h <- b95i %>%
  filter(R_11 == 0 | (R_11 >= 30 & R_11 <= 38))

n95h <- nrow(b95h)

### CPI standardized 
m95 <- b95h[, c(income_columns)]
b95c <- m95 * c95
b95h[income_columns] <- b95c

# For 1996 cohort
b96 <- fda_data %>%
  filter(birth_year_int %in% 1996)

b96 <- b96[, c(1:9,38:55, 64:133)]

old_names <- as.character(1996:2013)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b96)[names(b96) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n96 <- nrow(b96)

# Remove the individuals who can't track the family incomes
b96i <- b96 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n96i <- nrow(b96i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b96h <- b96i %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))

n96h <- nrow(b96h)

### CPI standardized 
m96 <- b96h[, c(income_columns)]
b96c <- m96 * c96
b96h[income_columns] <- b96c


# For 1997 cohort
b97 <- fda_data %>%
  filter(birth_year_int %in% 1997)

b97 <- b97[, c(1:9,39:56, 64:133)]

old_names <- as.character(1997:2014)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b97)[names(b97) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n97 <- nrow(b97)

# Remove the individuals who can't track the family incomes
b97i <- b97 %>%
 filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n97i <- nrow(b97i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b97h <- b97i %>%
  filter(R_13 == 0 | (R_13 >= 30 & R_13 <= 38))

n97h <- nrow(b97h)

### CPI standardized 
m97 <- b97h[, c(income_columns)]
b97c <- m97 * c97
b97h[income_columns] <- b97c

# For 1998 cohort
b98 <- fda_data %>%
  filter(birth_year_int %in% 1998)

b98 <- b98[, c(1:9,40:57, 64:133)]

old_names <- as.character(1998:2015)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b98)[names(b98) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n98 <- nrow(b98)

# Remove the individuals who can't track the family incomes
b98i <- b98 %>%
 filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n98i <- nrow(b98i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b98h <- b98i %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))

n98h <- nrow(b98h)

### CPI standardized 
m98 <- b98h[, c(income_columns)]
b98c <- m98 * c98
b98h[income_columns] <- b98c

# For 1999 cohort
b99 <- fda_data %>%
  filter(birth_year_int %in% 1999)

b99 <- b99[, c(1:9,41:58, 64:133)]

old_names <- as.character(1999:2016)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b99)[names(b99) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n99 <- nrow(b99)

# Remove the individuals who can't track the family incomes
b99i <- b99 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n99i <- nrow(b99i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b99h <- b99i %>%
  filter(R_15 == 0 | (R_15 >= 30 & R_15 <= 38))

n99h <- nrow(b99h)

### CPI standardized 
m99 <- b99h[, c(income_columns)]
b99c <- m99 * c99
b99h[income_columns] <- b99c

# For 2000 cohort
b00 <- fda_data %>%
  filter(birth_year_int %in% 2000)

b00 <- b00[, c(1:9,42:59, 64:133)]

old_names <- as.character(2000:2017)
new_names <- paste0("pa_inc_", 0:17)

# Rename income rows
names(b00)[names(b00) %in% old_names] <- new_names
income_columns <- paste0("pa_inc_", 0:17) 

n00 <- nrow(b00)

# Remove the individuals who can't track the family incomes
b00i <- b00 %>%
  filter(rowSums(across(all_of(income_columns), ~ !is.na(.) & . != 0)) >= 5)

n00i <- nrow(b00i)

# Filter relation to the head variable is between 30-38 or 0 at age 17
b00h <- b00i %>%
  filter(R_17 == 0 | (R_17 >= 30 & R_17 <= 38))

n00h <- nrow(b00h)

### CPI standardized 
m00 <- b00h[, c(income_columns)]
b00c <- m00 * c00
b00h[income_columns] <- b00c
```

### Combination of each wave

```{r}
T6 <- bind_rows(
  b68h, b69h, b70h, b71h, b72h, b73h, b74h, b75h, b76h, b77h,
  b78h, b79h, b80h, b81h, b82h, b83h, b84h, b85h, b86h, b87h,
  b88h, b89h, b90h, b91h, b92h, b93h, b94h, b95h, b96h, b97h,
  b98h, b99h, b00h
)


T6 <- T6 %>%
 select(ID, sex, birth_year, age_end_2021, 
         age_at_first_birth,
         No_birth_in_recently_updated_year,
         first_child_born,
         year_birth_info_most_recently_updated, 
         had_children_before_2021,Wtr_sample,all_of(par_inc))

NT6<- nrow(T6)

# remove the individuals who is followable nonsample parent or nonsample elderly. 

T6i <- T6 %>%
  filter(!(Wtr_sample %in% c(5, 6)))

## Remove filter variables
T6i <- T6i %>%
  select (-Wtr_sample)

```

### 1. Summary of Observations with Missing Income Data

#### Total Observations

```{r}
# Total number of observations
total_observations <- nrow(T6i)
total_observations
```

#### Missing Income Years

```{r}
# Calculate the number of missing income values per observation
T6i$missing_years <- rowSums(is.na(T6i[ , income_columns]))

# Create a summary table of the number of observations with missing years
missing_income_table <- table(T6i$missing_years)
missing_income_table
```

#### Zero-Income Years

```{r}
# Calculate the number of zero-income values per observation
T6i$zero_income_years <- rowSums(T6i[ , income_columns] == 0, na.rm = TRUE)

# Create a summary table of the number of observations with zero-income years
zero_income_table <- table(T6i$zero_income_years)
zero_income_table
```

### 2. Handling Missing Income Data

#### Dropping Observations with 6 or More Missing Years

```{r}
# Let negative value in data set as NA

data_filtered <- T6i %>%
  mutate(across(all_of(income_columns), ~ ifelse(. < 0, NA, .)))
data_filtered <- data_filtered %>% filter(missing_years < 6)


# Drop observations with 6 or more missing years
# data_filtered <- T6i %>% filter(missing_years < 6)
nrow(data_filtered)
```

#### Imputation of Missing/Zero-Income Values

```{r}
# Function to impute missing income values
impute_income <- function(income_vec) {
  # Iterate through income_vec to find and impute each missing value (NA)
  for (i in 1:length(income_vec)) {
    if (is.na(income_vec[i])) {
      # Find the first non-missing value before the current index
      before_indices <- which(!is.na(income_vec[1:(i-1)]))
      before <- if (length(before_indices) > 0) max(before_indices) else NA
      
      # Find the first non-missing value after the current index
      after_indices <- which(!is.na(income_vec[(i+1):length(income_vec)]))
      after <- if (length(after_indices) > 0) (i + after_indices[1]) else NA
      
      if (!is.na(before) && !is.na(after)) {
        # If both previous and next values are present, impute with their mean
        income_vec[i] <- mean(c(income_vec[before], income_vec[after]), na.rm = TRUE)
      } else if (!is.na(before) && is.na(after)) {
        # If all subsequent values are missing, fill all future missing values with the value at 'before'
        income_vec[i:length(income_vec)] <- income_vec[before]
        break  # Exit loop once future missing values are filled
      }
    }
  }
  
  return(income_vec)
}




impute_income2 <- function(income_vec) {
  i <- 1
  while (i <= length(income_vec)) {
    if (is.na(income_vec[i])) {
      # 找到前面的非缺失值
      before_indices <- which(!is.na(income_vec[1:(i-1)]))
      before <- if (length(before_indices) > 0) max(before_indices) else NA
      
      # 找到后面的非缺失值
      after_indices <- which(!is.na(income_vec[(i+1):length(income_vec)]))
      after <- if (length(after_indices) > 0) (i + after_indices[1]) else NA
      
      if (!is.na(before) && !is.na(after)) {
        # 计算连续缺失值的数量
        missing_count <- 0
        while (i + missing_count <= length(income_vec) && is.na(income_vec[i + missing_count])) {
          missing_count <- missing_count + 1
        }
        
        # 对每个缺失值进行线性插值
        for (k in 1:missing_count) {
          income_vec[i + k - 1] <- (income_vec[before] * (missing_count - k + 1) / (missing_count + 1)) +
                                   (income_vec[after] * k / (missing_count + 1))
        }
        
        i <- i + missing_count  # 跳过已经填充的缺失值
        
      } else if (!is.na(before) && is.na(after)) {
        # 如果右边全是缺失值，直接用前面的值填充
        income_vec[i:length(income_vec)] <- income_vec[before]
        break
      }
    } else {
      i <- i + 1
    }
  }
  
  return(income_vec)
}


```

#### B spline interpolation

```{r}
interpolate_b_spline <- function(data) {
  interpolated_data <- t(apply(data, 1, function(row) {
    non_na_indices <- which(!is.na(row))   
    na_indices <- which(is.na(row))        
    
    # If no missing value, keep original value
    if (length(na_indices) == 0) {
      return(row)
    }
    
    # B-Spline interpolation
    interpolated_values <- spline(non_na_indices, row[non_na_indices], xout = na_indices, method = "natural")$y
    
    # Check the interpolated values and prevent them from being less than 0
    for (i in seq_along(interpolated_values)) {
      if (interpolated_values[i] < 0) {
        # Use the last known value if available
        if (length(non_na_indices) > 0) {
          # Replace negative interpolated value with the last known value or zero
          interpolated_values[i] <- max(0, row[non_na_indices[length(non_na_indices)]])
        }
      }
    }
    
    # Replace the NA positions with the adjusted interpolated values
    row[na_indices] <- interpolated_values
    return(row)
  }))
  
  return(interpolated_data)
}


base_spline <- interpolate_b_spline(base_income)
```

#### Piecewise Cubic Hermitean Interpolation Polynomials

```{r}

pchip_inter <- function(data) {
  interpolated_data <- t(apply(data, 1, function(row) {
    
    # Identify non-NA and NA indices
    non_na_indices <- which(!is.na(row))
    na_indices <- which(is.na(row))
    
    # Check if the last value in the row is NA
    if (is.na(row[length(row)])) {
      # Find the last non-NA index
      last_non_na_index <- max(non_na_indices)
      # Only consider NAs before the last non-NA
      na_indices <- na_indices[na_indices < last_non_na_index]
      
      if (length(na_indices) == 0) {
        return(row)  # Return row as is if no NA values to interpolate
      }
    }

    # Perform PCHIP interpolation on the non-NA values
    interpolated_values <- pchip(non_na_indices, row[non_na_indices], na_indices)
    row[na_indices] <- interpolated_values
    
    return(row)
  }))
  
  return(interpolated_data)
}

```

### 3. Creating Alternative Family Income Measures

#### Base Income Measure (inc_t)

```{r}
# Use the imputed income values as the base measure
base_income <- data_filtered[ , c(income_columns)]

base_pchip <- pchip_inter(base_income)

```

###### matplot

```{r}

plot_income_curves <- function(original_data, interpolated_data, sample_size = nrow(original_data)) {
  # Check if sample_size is greater than the number of available samples
  if (sample_size > nrow(original_data)) {
    stop("Sample size cannot be greater than the number of rows in the dataset.")
  }
  
  # Randomly select sample indices if sample_size is smaller than total number of rows
  sample_indices <- sample(1:nrow(original_data), size = sample_size, replace = FALSE)
  
  # Subset the original and interpolated data
  sampled_original_data <- original_data[sample_indices, ]
  sampled_interpolated_data <- interpolated_data[sample_indices, ]
  
  # Plot original income curves
  matplot(t(sampled_original_data), type = "p", pch = 19, col = 1:nrow(sampled_original_data), 
          xlab = "Years", ylab = "Income", main = "Original and Interpolated Income Curves")
  
  # Plot interpolated curves
  matlines(t(sampled_interpolated_data), lty = 1, col = 1:nrow(sampled_original_data))
  
  # Add legend
  legend("topright", legend = c("Original Data", "Interpolated Curves"), 
         pch = c(19, NA), lty = c(NA, 1), col = 2,cex = 0.8,
         bty = "n")  
  
}

```

###### pchip

```{r}
plot_income_curves(base_income, base_pchip)
```

```{r}
plot_income_curves(base_income, 
                   base_pchip, 
                   sample_size = 20)
```

###### b spline

```{r}
plot_income_curves(base_income, 
                   base_spline)
```

```{r}
plot_income_curves(base_income, 
                   base_spline,
                   sample_size = 20)
```

### Remove the data which the last equal to NA

```{r}
n_income <- base_income %>%
  filter(!is.na(.[[ncol(.)]]))
last_col_index <- ncol(base_pchip)
n_pchip <- base_pchip[!is.na(base_pchip[, last_col_index]), ]
n_spline<- base_spline[!is.na(base_spline[, last_col_index]), ]
```

###### pchip

```{r}
plot_income_curves(n_income, n_pchip)
```

```{r}
plot_income_curves(n_income, 
                   n_pchip, 
                   sample_size = 15)
```

###### b spline

```{r}
plot_income_curves(n_income, 
                   n_spline)
```

```{r}
plot_income_curves(n_income, 
                   n_spline,
                   sample_size = 20)
```



## Log base income 

```{r}
base_pchip_log= base_pchip
base_pchip[base_pchip<100]<-100
base_pchip_log[base_pchip_log < 100] <- 100
base_pchip_log<- log(base_pchip_log)
```


```{r}
matplot(t(base_pchip_log), type = "l", lty = 1,  xlab = "Time", ylab = "Log Income", main = "Log Income ")
```

#### Samples

```{r}
log_sample <- base_pchip_log[100:330,]
matplot(t(log_sample), type = "l", lty = 1, col = 1:10 , xlab = "Time", ylab = "Log Income", main = "Log Income for 15 Samples")
```





## Proportional method


```{r}
total_income <- rowSums(base_pchip, na.rm = TRUE)
proportional_income <- base_pchip / total_income

total_income1 <- rowSums(base_income, na.rm = TRUE)
n_p<- base_income / total_income1
```


```{r}
matplot(proportional_income,type = "l")
```

```{r}
sample<- proportional_income[30:45,]

matplot(t(sample), type = "l", lty = 1, col = 1:10,ylim = c(0,0.2) , xlab = "Time", ylab = "Proportional Income", main = "Proportional Income for 30 Samples")
```





## Cluster

```{r}
library(dtwclust)
library(ggplot2)
library(reshape2)
```

```{r}
income_data_pchip <- base_pchip
income_data_spline<- base_spline
```

### pchip cluster

```{r}
# Perform clustering analysis using DTW distance matrix and k-means
set.seed(123)
k <- 3  # Set the number of clusters
kmeans_dtw_pchip <- tsclust(income_data_pchip, type = "partitional", k = k, distance = "dtw", centroid = "pam",
                      preproc = zscore, seed = 222, trace = TRUE)

# Output the clustering results
income_data_pchip$cluster <- as.factor(kmeans_dtw_pchip@cluster)
```

### b spline cluster

```{r}
# Perform clustering analysis using DTW distance matrix and k-means
set.seed(20000)
k <- 3  # Set the number of clusters
kmeans_dtw_spline <- tsclust(income_data_spline, type = "partitional", k = k, distance = "dtw", centroid = "pam",
                      preproc = zscore, seed = 20000, trace = TRUE)

# Output the clustering results
income_data_spline$cluster <- as.factor(kmeans_dtw_spline@cluster)
```

## Plot the cluster result

### pchip cluster

```{r}
income_melt_pchip <- melt(income_data_pchip, id.vars = c("ID", "cluster"), variable.name = "year", value.name = "income")
ggplot(income_melt_pchip, aes(x = year, y = income, color = cluster, group = ID)) +
  geom_line(alpha = 0.7) +
  labs(title = "Income Curves by Cluster", x = "Year", y = "Income") +
  theme_minimal()
```

### b spline cluster

```{r}
income_melt_spline <- melt(income_data_spline, id.vars = c("ID", "cluster"), variable.name = "year", value.name = "income")
ggplot(income_melt_spline, aes(x = year, y = income, color = cluster, group = ID)) +
  geom_line(alpha = 0.7) +
  labs(title = "Income Curves by Cluster", x = "Year", y = "Income") +
  theme_minimal()
```


## Action


Drop all rows where you imputed a 100
Run the estimation: Y_i = b0 + b1Var(Fam_inc_1to17_i) + b2Mean(Fam_inc_1to17_i) + u_i
 
Run the estimation: Y_i = b0 + b1Var(Fam_inc_1to17_i) + b2Mean(Fam_inc_1to17_i) + u_i
   


```{r}
df_reg <- cbind(birth_number = data_filtered$No_birth_in_recently_updated_year, has_kids = data_filtered$had_children_before_2021, base_pchip)
df_reg <- as.data.frame(df_reg)


df_reg$has_kid_binary <- ifelse(df_reg$has_kids == "Y", 1, 0)


df_reg_binary <- df_reg[, c(ncol(df_reg), 2:(ncol(df_reg) - 1))]  # has_kid_binary 
df_reg_binary<- df_reg_binary[,-2]



df_reg <- df_reg[, -c(2, ncol(df_reg))]  

```


Drop all rows where you imputed a 100
Run the estimation: Y_i = b0 + b1Var(Fam_inc_1to17_i) + b2Mean(Fam_inc_1to17_i) + u_i


```{r}
# Filter out rows with any 100 values in columns other than the first
df_reg_1 <- df_reg %>%
  filter(if_all(-1, ~ . != 100 | is.na(.)))
```


Run the first model

The first model estimates the relationship:

$$Y_i(Birth {\_} Number) = b_0 + b_1 Var(Fam{\_}inc \ (1to17_i))+ b_2 Mean(Fam{\_}inc(1to17_i)) + b_3(Trend) + u_i$$
```{r}
# Convert columns to numeric
df_reg_1[, -1] <- lapply(df_reg_1[, -1], as.numeric)

# Compute the standard deviation and mean for each individual (row) from the income data
df_reg_1$sd_inc <- apply(df_reg_1[, -1], 1, sd, na.rm = TRUE)
df_reg_1$mean_inc <- rowMeans(df_reg_1[, -1], na.rm = TRUE)

# Filter out rows where mean_inc is NA
df_reg_1 <- df_reg_1[!is.na(df_reg_1$mean_inc), ]

# Initialize the trend column
df_reg_1$trend <- NA

# Loop to calculate the trend for each individual
for (i in 1:nrow(df_reg_1)) {
  income_data <- as.numeric(df_reg_1[i, 2:19])
  time <- 1:length(income_data)
  
  # Only fit the model if there are at least 2 non-NA values
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_reg_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model with the added trend variable
model_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_reg_1)
```


```{r}
# Convert columns to numeric
df_reg[, -1] <- lapply(df_reg[, -1], function(x) as.numeric(as.character(x)))

# Compute the standard deviation and mean for each individual (row) in the full dataset
df_reg$sd_inc <- apply(df_reg[, -1], 1, sd, na.rm = TRUE)
df_reg$mean_inc <- rowMeans(df_reg[, -1], na.rm = TRUE)

# Filter out rows where mean_inc is NA
df_reg <- df_reg[!is.na(df_reg$mean_inc), ]


# Initialize the trend column
df_reg$trend <- NA

# Loop to calculate the trend for each individual
for (i in 1:nrow(df_reg)) {
  income_data <- as.numeric(df_reg[i, 2:19])
  time <- 1:length(income_data)
  
  # Only fit the model if there are at least 2 non-NA values
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_reg$trend[i] <- coef(trend_model)[2]
  }
}

# Run the second model including the trend variable
model_2 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_reg)
```


## Log measure

```{r}
df_reg_log<-df_reg
df_reg_log_1<- df_reg_1
df_reg_log[, -1] <- lapply(df_reg_log[, -1], function(x) log(as.numeric(as.character(x))))
df_reg_log_1[, -1] <- lapply(df_reg_log_1[, -1], function(x) log(as.numeric(as.character(x))))
```


```{r}
# Compute the variance and mean for each individual (row) from the income data (columns 2 to 18)
df_reg_log_1$sd_inc <- apply(df_reg_log_1[, -1], 1, sd, na.rm = TRUE)
df_reg_log_1$mean_inc <- rowMeans(df_reg_log_1[, -1], na.rm = TRUE)

# Filter out rows where mean_inc is NA
df_reg_log_1 <- df_reg_log_1[!is.na(df_reg_log_1$mean_inc), ]


# Initialize the trend column
df_reg_log_1$trend <- NA

# Loop to calculate the trend for each individual
for (i in 1:nrow(df_reg_log_1)) {
  income_data <- as.numeric(df_reg_log_1[i, 2:19])
  time <- 1:length(income_data)
  
  # Only fit the model if there are at least 2 non-NA values
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_reg_log_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model including the trend variable
model_log_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_reg_log_1)
```



```{r}
# Compute the variance and mean for each individual (row) from the income data (columns 4 to 21)
df_reg_log$sd_inc <- apply(df_reg_log[,-1], 1, sd, na.rm = TRUE)
df_reg_log$mean_inc <- rowMeans(df_reg_log[, -1], na.rm = TRUE)

# Filter out rows where mean_inc is NA
df_reg_log <- df_reg_log[!is.na(df_reg_log$mean_inc), ]

# Initialize the trend column
df_reg_log$trend <- NA

# Loop to calculate the trend for each individual
for (i in 1:nrow(df_reg_log)) {
  income_data <- as.numeric(df_reg_log[i, 2:19])
  time <- 1:length(income_data)
  
  # Only fit the model if there are at least 2 non-NA values
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_reg_log$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model including the trend variable
model_log <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_reg_log)
```

### Poisson

```{r}
df_reg_log_po <- df_reg_log_1[apply(df_reg_log_1[, 2:19], 1, function(x) !any(is.na(x))), ]
# Convert columns to numeric
df_reg_log_po <- lapply(df_reg_log_po, as.numeric)

poisson_model <- glm(birth_number ~  mean_inc + sd_inc, 
                     family = poisson(link = "log"), 
                     data = df_reg_log_po)
```


#### Scaled model


```{r}
# Create scaled variables for full dataset
df_reg_log_po$scaled_sd_inc <- df_reg_log_po$sd_inc / df_reg_log_po$mean_inc
df_reg_log_po$scaled_trend <- df_reg_log_po$trend / df_reg_log_po$mean_inc

# Run Poisson model with scaled variables for full dataset
poisson_model_reg_s <- glm(birth_number ~ scaled_sd_inc + scaled_trend+ mean_inc, 
                           family = poisson(link = "log"), 
                           data = df_reg_log_po)
```



```{r}
# Display model results with stargazer and custom column labels
stargazer(
  model_2, 
  model_1, 
  model_log, 
  model_log_1,
  poisson_model,
  type = "text",
  title = "Regression Models Summary for All individuals Income Analysis",
  model.names = FALSE,
  column.labels = c("All without drop", "All with drop", "All (Logged without drop)", "All (Logged with drop)","poisson_model (Logged with drop)")
)
```



### Group the income level

#### Original dataframe without drop


```{r}
df_reg$income_group <- cut(df_reg$mean_inc, 
                           breaks = quantile(df_reg$mean_inc, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE), 
                           labels = c("Poor", "Middle", "Rich"), 
                           include.lowest = TRUE)
```



```{r}
# Run the regression model for the "poor" group
model_poor <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg[df_reg$income_group == "Poor", ])
```



```{r}
# Run the regression model for the "middle" group
model_middle <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg[df_reg$income_group == "Middle", ])

```



```{r}
# Run the regression model for the "richest" group
model_rich <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg[df_reg$income_group == "Rich", ])
```



```{r}
stargazer(model_poor,model_middle,model_rich,type = "text")
```



#### Original dataframe with drop

```{r}
df_reg_1$income_group <- cut(df_reg_1$mean_inc, 
                           breaks = quantile(df_reg_1$mean_inc, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
                           labels = c("Poor", "Middle", "Rich"), 
                           include.lowest = TRUE)

```



```{r}
# Run the regression model for the "poor" group
model_poor_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_1[df_reg_1$income_group == "Poor", ])
```



```{r}
# Run the regression model for the "middle" group
model_middle_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_1[df_reg_1$income_group == "Middle", ])
```



```{r}
# Run the regression model for the "richest" group
model_rich_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_1[df_reg_1$income_group == "Rich", ])
```

```{r}
stargazer(model_poor_1,model_middle_1,model_rich_1,type = "text")
```


### Log measure

#### Log dataframe without drop

```{r}
# Create income group based on mean income for df_reg_log
df_reg_log$income_group <- cut(df_reg_log$mean_inc, 
                               breaks = quantile(df_reg_log$mean_inc, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE), 
                               labels = c("Poor", "Middle", "Rich"), 
                               include.lowest = TRUE)

# Run the regression model for the "poor" group in df_reg_log
model_poor_log <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log[df_reg_log$income_group == "Poor", ])


# Run the regression model for the "middle" group in df_reg_log
model_middle_log <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log[df_reg_log$income_group == "Middle", ])


# Run the regression model for the "rich" group in df_reg_log
model_rich_log <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log[df_reg_log$income_group == "Rich", ])

```


```{r}
stargazer(model_poor_log,model_middle_log,model_rich_log,type = "text")
```




#### Log dataframe with drop
```{r}
# Create income group based on mean income for df_reg_log_1 after dropping values below 100
df_reg_log_1$income_group <- cut(df_reg_log_1$mean_inc, 
                                 breaks = quantile(df_reg_log_1$mean_inc, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE), 
                                 labels = c("Poor", "Middle", "Rich"), 
                                 include.lowest = TRUE)

# Run the regression model for the "poor" group in df_reg_log_1
model_poor_log_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log_1[df_reg_log_1$income_group == "Poor", ])


# Run the regression model for the "middle" group in df_reg_log_1
model_middle_log_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log_1[df_reg_log_1$income_group == "Middle", ])


# Run the regression model for the "rich" group in df_reg_log_1
model_rich_log_1 <- lm(birth_number ~ sd_inc + mean_inc+trend, data = df_reg_log_1[df_reg_log_1$income_group == "Rich", ])
stargazer(model_poor_log_1,model_middle_log_1,model_rich_log_1,type = "text")
```



## Loops of trend variables

```{r}
# Initialize a vector to store the trend coefficients for each individual
df_reg$trend <- NA
```

```{r}
# Loop through each individual (each row)
for (i in 1:nrow(df_reg)) {
  # Extract the income data for the individual, ignoring the ID and other columns
  income_data <- as.numeric(df_reg_1[i, 2:19])
  time <- 1:length(income_data)
  
  # Check if there are enough non-NA values to fit a model (e.g., at least 2 points)
  if (sum(!is.na(income_data)) >= 2) {
    # Fit a linear model for the income curve of the individual
    trend_model <- lm(income_data ~ time)
  
  # Store the slope coefficient (representing the trend) in the trend column
  df_reg$trend[i] <- coef(trend_model)[2]}
}
```





## Binary analysis


```{r}
df_reg_binary[, -1] <- lapply(df_reg_binary[, -1], function(x) as.numeric(as.character(x)))
# Compute the variance and mean for each individual (row) from the income data (columns 2 to 18)
df_reg_binary$sd_inc <- apply(df_reg_binary[, -1], 1, sd, na.rm = TRUE)
df_reg_binary$mean_inc <- rowMeans(df_reg_binary[, -1], na.rm = TRUE)

# Run the first linear model (drop all rows which imputed by 100)
model_bin_1 <- lm(has_kid_binary ~ sd_inc + mean_inc, data = df_reg_binary)
summary(model_bin_1)
```




```{r}
df_reg_binary_1<- df_reg_binary[!apply(df_reg_binary[, -1] == 100, 1, any), ]
df_reg_binary_1[, -1] <- lapply(df_reg_binary_1[, -1], function(x) as.numeric(as.character(x)))
# Compute the variance and mean for each individual (row) in the full dataset
df_reg_binary_1$sd_inc <- apply(df_reg_binary_1[, -1], 1, sd, na.rm = TRUE)
df_reg_binary_1$mean_inc <- rowMeans(df_reg_binary_1[, -1], na.rm = TRUE)

# Run the second linear model (Without drop)
model_bin_1 <- lm(has_kid_binary ~ sd_inc + mean_inc, data = df_reg_binary_1)
summary(model_bin_1)
```



### Log Binary Analysis


```{r}
df_reg_binary_log<- df_reg_binary
df_reg_binary_log[, -1] <- lapply(df_reg_binary[, -1], function(x) log(as.numeric(as.character(x))))
# Compute the variance and mean for each individual (row) from the income data (columns 2 to 18)
df_reg_binary_log$sd_inc <- apply(df_reg_binary_log[, -1], 1, sd, na.rm = TRUE)
df_reg_binary_log$mean_inc <- rowMeans(df_reg_binary_log[, -1], na.rm = TRUE)

# Run the first linear model (drop all rows which imputed by 100)
model_bin_log <- lm(has_kid_binary ~ sd_inc + mean_inc, data = df_reg_binary_log)
summary(model_bin_log)
```



```{r}
df_reg_binary_log_1<-df_reg_binary_1
df_reg_binary_log_1[, -1] <- lapply(df_reg_binary_log_1[, -1], function(x) log(as.numeric(as.character(x))))
# Compute the variance and mean for each individual (row) in the full dataset
df_reg_binary_log_1$sd_inc <- apply(df_reg_binary_log_1[, -1], 1, sd, na.rm = TRUE)
df_reg_binary_log_1$mean_inc <- rowMeans(df_reg_binary_log_1[, -1], na.rm = TRUE)

# Run the second linear model (Without drop)
model_bin_log_1 <- lm(has_kid_binary ~ sd_inc + mean_inc, data =df_reg_binary_log_1)
summary(model_bin_log_1)
```



## Cohort analysis 





### Data Preparation

```{r}
df_co <- cbind(df_reg, sex = data_filtered$sex)

## For husband group with drops and log measure 
df_m <- subset(df_co, sex == 1)
df_m$sex <- NULL
df_m_1<- df_m %>%
  filter(if_all(-1, ~ . != 100 | is.na(.)))
### log

df_m_log <- df_m
df_m_log[, 2:19] <- lapply(df_m[, 2:19], function(x) log(as.numeric(as.character(x))))

df_m_log_1 <- df_m_1
df_m_log_1[, 2:19] <- lapply(df_m_1[, 2:19], function(x) log(as.numeric(as.character(x))))

## For wife group with drops and log measure
df_f <- subset(df_co, sex == 2)
df_f$sex <- NULL
df_f_1<- df_f %>%
  filter(if_all(-1, ~ . != 100 | is.na(.)))

df_f_log <- df_f
df_f_log[, 2:19] <- lapply(df_f[, 2:19], function(x) log(as.numeric(as.character(x))))

df_f_log_1 <- df_f_1
df_f_log_1[, 2:19] <- lapply(df_f_1[, 2:19], function(x) log(as.numeric(as.character(x))))
```


### For husband - filter the sex as male

#### Without drops
```{r}
# Compute variance and mean for each individual in `df_m` for columns 2 to 19
df_m$sd_inc <- apply(df_m[, 2:19], 1, sd, na.rm = TRUE)
df_m$mean_inc <- rowMeans(df_m[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values
df_m <- df_m[!is.na(df_m$mean_inc), ]

# Initialize the trend column
df_m$trend <- NA

# Calculate the income trend for each individual
for (i in 1:nrow(df_m)) {
  income_data <- as.numeric(df_m[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_m$trend[i] <- coef(trend_model)[2]
  }
}

# Run linear model including trend variable
model_m <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_m)
```

#### With drops

```{r}
# Compute variance and mean for each individual in `df_m` for columns 2 to 19
df_m_1$sd_inc <- apply(df_m_1[, 2:19], 1, sd, na.rm = TRUE)
df_m_1$mean_inc <- rowMeans(df_m_1[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values
df_m_1 <- df_m_1[!is.na(df_m_1$mean_inc), ]

# Initialize the trend column
df_m_1$trend <- NA

# Calculate the income trend for each individual
for (i in 1:nrow(df_m_1)) {
  income_data <- as.numeric(df_m_1[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_m_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run linear model including trend variable
model_m_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_m_1)
```


### Log measure 

```{r}
# Process `df_m_log` dataset: Compute the variance and mean for income columns (2 to 19 after log transformation)
df_m_log$sd_inc <- apply(df_m_log[, 2:19], 1, sd, na.rm = TRUE)
df_m_log$mean_inc <- rowMeans(df_m_log[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values in `df_m_log`
df_m_log <- df_m_log[!is.na(df_m_log$mean_inc), ]

# Initialize trend column in `df_m_log`
df_m_log$trend <- NA

# Calculate the trend for each individual in `df_m_log`
for (i in 1:nrow(df_m_log)) {
  income_data <- as.numeric(df_m_log[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_m_log$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model with the `df_m_log` dataset
model_m_log <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_m_log)

# Process `df_m_log_1` dataset similarly
df_m_log_1$sd_inc <- apply(df_m_log_1[, 2:19], 1, sd, na.rm = TRUE)
df_m_log_1$mean_inc <- rowMeans(df_m_log_1[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values in `df_m_log_1`
df_m_log_1 <- df_m_log_1[!is.na(df_m_log_1$mean_inc), ]

# Initialize trend column in `df_m_log_1`
df_m_log_1$trend <- NA

# Calculate the trend for each individual in `df_m_log_1`
for (i in 1:nrow(df_m_log_1)) {
  income_data <- as.numeric(df_m_log_1[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_m_log_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model with the `df_m_log_1` dataset
model_m_log_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_m_log_1)
```


#### Poisson 


```{r}
df_m_log_po <- df_m_log_1[apply(df_m_log_1[, 2:19], 1, function(x) !any(is.na(x))), ]
# Convert columns to numeric
df_m_log_po <- lapply(df_m_log_po, as.numeric)

poisson_model_m <- glm(birth_number ~  mean_inc + sd_inc,
                     family = poisson(link = "log"), 
                     data = df_m_log_po)
```


#### Scaled variables


```{r}
# Create scaled variables for males group
df_m_log_po$scaled_sd_inc <- df_m_log_po$sd_inc / df_m_log_po$mean_inc
df_m_log_po$scaled_trend <- df_m_log_po$trend / df_m_log_po$mean_inc

# Run Poisson model with scaled variables for males group
poisson_model_m_s <- glm(birth_number ~ scaled_sd_inc + scaled_trend+mean_inc, 
                         family = poisson(link = "log"), 
                         data = df_m_log_po)

```



```{r}
# Display model results with stargazer
stargazer(
  model_m, 
  model_m_1, 
  model_m_log, 
  model_m_log_1,
  poisson_model_m,
  type = "text",
  title = "Regression Models Summary for Males Income Analysis",
  model.names = FALSE,
  column.labels = c("All males (without drop)", "All males (with drop)", "Males (Logged without drop)","Males (Logged with drop)","poisson_model (Logged with drop)")
)
```



### For Wife - filter the sex as male


```{r}
#### Without drops
# Compute variance and mean for each individual in `df_f` for columns 2 to 19
df_f$sd_inc <- apply(df_f[, 2:19], 1, sd, na.rm = TRUE)
df_f$mean_inc <- rowMeans(df_f[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values
df_f <- df_f[!is.na(df_f$mean_inc), ]

# Initialize the trend column
df_f$trend <- NA

# Calculate the income trend for each individual
for (i in 1:nrow(df_f)) {
  income_data <- as.numeric(df_f[i, 2:19])
  time <- 1:length(income_data)
  ## Ensure that the trend model successfully runs for each row with NA values, requiring at least 2 non-missing points to obtain a trend value.
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_f$trend[i] <- coef(trend_model)[2]
  }
}

# Run linear model including trend variable for females
model_f <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_f)

#### With drops
# Compute variance and mean for each individual in `df_f_1` for columns 2 to 19
df_f_1$sd_inc <- apply(df_f_1[, 2:19], 1, sd, na.rm = TRUE)
df_f_1$mean_inc <- rowMeans(df_f_1[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values
df_f_1 <- df_f_1[!is.na(df_f_1$mean_inc), ]

# Initialize the trend column
df_f_1$trend <- NA

# Calculate the income trend for each individual
for (i in 1:nrow(df_f_1)) {
  income_data <- as.numeric(df_f_1[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_f_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run linear model including trend variable for females with drops
model_f_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_f_1)

### Log measure for female
# Process `df_f_log` dataset: Compute the variance and mean for income columns (2 to 19 after log transformation)
df_f_log$sd_inc <- apply(df_f_log[, 2:19], 1, sd, na.rm = TRUE)
df_f_log$mean_inc <- rowMeans(df_f_log[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values in `df_f_log`
df_f_log <- df_f_log[!is.na(df_f_log$mean_inc), ]

# Initialize trend column in `df_f_log`
df_f_log$trend <- NA

# Calculate the trend for each individual in `df_f_log`
for (i in 1:nrow(df_f_log)) {
  income_data <- as.numeric(df_f_log[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_f_log$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model with the `df_f_log` dataset
model_f_log <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_f_log)

# Process `df_f_log_1` dataset similarly
df_f_log_1$sd_inc <- apply(df_f_log_1[, 2:19], 1, sd, na.rm = TRUE)
df_f_log_1$mean_inc <- rowMeans(df_f_log_1[, 2:19], na.rm = TRUE)

# Filter rows with non-NA mean values in `df_f_log_1`
df_f_log_1 <- df_f_log_1[!is.na(df_f_log_1$mean_inc), ]

# Initialize trend column in `df_f_log_1`
df_f_log_1$trend <- NA

# Calculate the trend for each individual in `df_f_log_1`
for (i in 1:nrow(df_f_log_1)) {
  income_data <- as.numeric(df_f_log_1[i, 2:19])
  time <- 1:length(income_data)
  
  if (sum(!is.na(income_data)) >= 2) {
    trend_model <- lm(income_data ~ time)
    df_f_log_1$trend[i] <- coef(trend_model)[2]
  }
}

# Run the model with the `df_f_log_1` dataset
model_f_log_1 <- lm(birth_number ~ sd_inc + mean_inc + trend, data = df_f_log_1)
```



#### Poisson



```{r}
df_f_log_po <- df_f_log_1[apply(df_f_log_1[, 2:19], 1, function(x) !any(is.na(x))), ]
# Convert columns to numeric
df_f_log_po <- lapply(df_f_log_po, as.numeric)

poisson_model_f <- glm(birth_number ~ mean_inc + sd_inc, 
                     family = poisson(link = "log"), 
                     data = df_f_log_po)
```

##### Scaled variables : sd_inc/mean_inc and trend/mean_inc


```{r}
# Create scaled variables
df_f_log_po$scaled_sd_inc <- df_f_log_po$sd_inc / df_f_log_po$mean_inc
df_f_log_po$scaled_trend <- df_f_log_po$trend / df_f_log_po$mean_inc

# Run Poisson model with scaled variables
poisson_model_f_s <- glm(birth_number ~ scaled_sd_inc + scaled_trend+mean_inc, 
                       family = poisson(link = "log"), 
                       data = df_f_log_po)
```








```{r}
# Display model results for females using stargazer
stargazer(
  model_f, 
  model_f_1, 
  model_f_log, 
  model_f_log_1,
  poisson_model_f ,
  type = "text",
  title = "Regression Models Summary for Female Income Analysis",
  model.names = FALSE,
  column.labels = c("All females (without drop)", "All females (with drop)", "Females (Logged without drop)","Females (Logged with drop)","poisson_model (Logged with drop)")
)
```


### robust standard errors

```{r}
robust_se <- coeftest(poisson_model, vcov = vcovHC(poisson_model, type = "HC"))
robust_se_m <- coeftest(poisson_model_m, vcov = vcovHC(poisson_model_m, type = "HC"))
robust_se_f <- coeftest(poisson_model_f, vcov = vcovHC(poisson_model_f, type = "HC"))
```

```{r}
stargazer(robust_se, robust_se_m, robust_se_f, 
          type = "text", 
          column.labels = c("All individuals", "Male", "Female"),
          title = "Poisson Regression Results with Robust Standard Errors")
```


### Histogram plot for drops dataframe


```{r}

library(ggplot2)
library(gridExtra)


# Create the plots with detailed titles
p1_sd <- ggplot(df_reg_1, aes(x = sd_inc)) + 
  geom_histogram(binwidth = 5000, fill = "blue", alpha = 0.7) + 
  ggtitle("All Individuals with Drops - SD\n(Each bar represents 5000 units of SD)")

p1_mean <- ggplot(df_reg_1, aes(x = mean_inc)) + 
  geom_histogram(binwidth = 5000, fill = "blue", alpha = 0.7) + 
  ggtitle("All Individuals with Drops - Mean Income\n(Each bar represents 5000 units of Mean Income)")

p1_trend <- ggplot(df_reg_1, aes(x = trend)) + 
  geom_histogram(binwidth = 1500, fill = "blue", alpha = 0.7) + 
  ggtitle("All Individuals with Drops - Trend\n(Each bar represents 1500 units of Trend)")

p2_sd <- ggplot(df_m_1, aes(x = sd_inc)) + 
  geom_histogram(binwidth = 5000, fill = "green", alpha = 0.7) + 
  ggtitle("Male Individuals - SD\n(Each bar represents 5000 units of SD)")

p2_mean <- ggplot(df_m_1, aes(x = mean_inc)) + 
  geom_histogram(binwidth = 5000, fill = "green", alpha = 0.7) + 
  ggtitle("Male Individuals - Mean Income\n(Each bar represents 5000 units of Mean Income)")

p2_trend <- ggplot(df_m_1, aes(x = trend)) + 
  geom_histogram(binwidth = 1500, fill = "green", alpha = 0.7) + 
  ggtitle("Male Individuals - Trend\n(Each bar represents 1500 units of Trend)")

p3_sd <- ggplot(df_f_1, aes(x = sd_inc)) + 
  geom_histogram(binwidth = 5000, fill = "red", alpha = 0.7) + 
  ggtitle("Female Individuals - SD\n(Each bar represents 5000 units of SD)")

p3_mean <- ggplot(df_f_1, aes(x = mean_inc)) + 
  geom_histogram(binwidth = 5000, fill = "red", alpha = 0.7) + 
  ggtitle("Female Individuals - Mean Income\n(Each bar represents 5000 units of Mean Income)")

p3_trend <- ggplot(df_f_1, aes(x = trend)) + 
  geom_histogram(binwidth = 1500, fill = "red", alpha = 0.7) + 
  ggtitle("Female Individuals - Trend\n(Each bar represents 1500 units of Trend)")

# Arrange all plots into a 3x3 grid
grid.arrange(p1_sd, p1_mean, p1_trend,
             p2_sd, p2_mean, p2_trend,
             p3_sd, p3_mean, p3_trend,
             nrow = 3, ncol = 3, 
             top = "Histograms of Variables")
```

## Heteroskedasticity-Consistent Standard Errors

### All
```{r}
stargazer(
  model_2, 
  model_1, 
  model_log, 
  model_log_1,
  poisson_model,
  type = "text",
  title = "Regression Models Summary for All Individuals Income Analysis with Heteroskedasticity-Consistent Standard Errors",
  model.names = FALSE,
  column.labels = c("All without drop", "All with drop", "All (Logged without drop)", "All (Logged with drop)", "Poisson Model (Logged with drop)","Scaled Poisson Model (Logged with drop)"),
  se = list(
    coeftest(model_2, vcov = vcovHC(model_2, type = "HC"))[, "Std. Error"],
    coeftest(model_1, vcov = vcovHC(model_1, type = "HC"))[, "Std. Error"],
    coeftest(model_log, vcov = vcovHC(model_log, type = "HC"))[, "Std. Error"],
    coeftest(model_log_1, vcov = vcovHC(model_log_1, type = "HC"))[, "Std. Error"],
    coeftest(poisson_model, vcov = vcovHC(poisson_model, type = "HC"))[, "Std. Error"]
  )
)
```

### Males

```{r}
stargazer(
  model_m, 
  model_m_1, 
  model_m_log, 
  model_m_log_1,
  poisson_model_m,
  type = "text",
  title = "Regression Models Summary for Males Income Analysis with Heteroskedasticity-Consistent Standard Errors",
  model.names = FALSE,
  column.labels = c("All males (without drop)", "All males (with drop)", "Males (Logged without drop)", "Males (Logged with drop)", "Scaled Poisson Model (Logged with drop)"),
  se = list(
    coeftest(model_m, vcov = vcovHC(model_m, type = "HC"))[, "Std. Error"],
    coeftest(model_m_1, vcov = vcovHC(model_m_1, type = "HC"))[, "Std. Error"],
    coeftest(model_m_log, vcov = vcovHC(model_m_log, type = "HC"))[, "Std. Error"],
    coeftest(model_m_log_1, vcov = vcovHC(model_m_log_1, type = "HC"))[, "Std. Error"],
    coeftest(poisson_model_m, vcov = vcovHC(poisson_model_m, type = "HC"))[, "Std. Error"]
  )
)
```
## Female

```{r}
stargazer(
  model_f, 
  model_f_1, 
  model_f_log, 
  model_f_log_1,
  poisson_model_f,
  type = "text",
  title = "Regression Models Summary for Female Income Analysis with Heteroskedasticity-Consistent Standard Errors",
  model.names = FALSE,
  column.labels = c("All females (without drop)", "All females (with drop)", "Females (Logged without drop)", "Females (Logged with drop)", "Scaled Poisson Model (Logged with drop)"),
  se = list(
    coeftest(model_f, vcov = vcovHC(model_f, type = "HC"))[, "Std. Error"],
    coeftest(model_f_1, vcov = vcovHC(model_f_1, type = "HC"))[, "Std. Error"],
    coeftest(model_f_log, vcov = vcovHC(model_f_log, type = "HC"))[, "Std. Error"],
    coeftest(model_f_log_1, vcov = vcovHC(model_f_log_1, type = "HC"))[, "Std. Error"],
    coeftest(poisson_model_f, vcov = vcovHC(poisson_model_f, type = "HC"))[, "Std. Error"]
  )
)
```



#### Scaled poisson model for all group


```{r}
stargazer(
  poisson_model_reg_s,
  poisson_model_m_s,
  poisson_model_f_s,
  type = "text",
  title = "Regression Models Summary for Scaled Poisson Estimation for all groups with Heteroskedasticity-Consistent Standard Errors",
  model.names = FALSE,
  column.labels = c("Scaled Poisson Model (All Individuals)", 
                    "Scaled Poisson Model (Males)", 
                    "Scaled Poisson Model (Females)"),
  se = list(
    coeftest(poisson_model_reg_s, vcov = vcovHC(poisson_model_reg_s, type = "HC"))[, "Std. Error"],
    coeftest(poisson_model_m_s, vcov = vcovHC(poisson_model_m_s, type = "HC"))[, "Std. Error"],
    coeftest(poisson_model_f_s, vcov = vcovHC(poisson_model_f_s, type = "HC"))[, "Std. Error"]
  )
)
```




